import{a as P}from"./chunk-QDXSJC2J.js";import{a as $}from"./chunk-O75NO46C.js";import{a as k}from"./chunk-PDHAO4X2.js";import"./chunk-NHPTLCVL.js";import{b as q}from"./chunk-WDXSJPWS.js";import{$ as C,E as f,F as u,K as z,L as d,M as c,N as I,S as F,U as S,Z as _,_ as m,aa as M,ea as T,g as x,j as h,ja as j,la as B,o as b,p as R,v as g,y as N}from"./chunk-FYXY47SE.js";import{a as A,b as D}from"./chunk-2NFLSA4Y.js";var w=class o{normalize(t){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").trim()}levenshteinDistance(t,e){let n=t.length,i=e.length,s=[];for(let r=0;r<=n;r++)s[r]=[r];for(let r=0;r<=i;r++)s[0][r]=r;for(let r=1;r<=n;r++)for(let a=1;a<=i;a++)t[r-1]===e[a-1]?s[r][a]=s[r-1][a-1]:s[r][a]=Math.min(s[r-1][a]+1,s[r][a-1]+1,s[r-1][a-1]+1);return s[n][i]}calculateSimilarity(t,e){let n=Math.max(t.length,e.length);if(n===0)return 100;let i=this.levenshteinDistance(t,e);return(n-i)/n*100}isSingleWordMatch(t,e){let n=this.normalize(t),i=this.normalize(e);return n===i||n.includes(i)||i.includes(n)?!0:i.length<=2?!1:i.length<5?this.calculateSimilarity(n,i)>=90:this.calculateSimilarity(n,i)>=80}isWordMatch(t,e){let n=this.normalize(t),i=this.normalize(e);if(n===i||n.includes(i)||i.includes(n))return!0;let s=n.split(/\s+/).filter(r=>r.length>0);for(let r of s)if(this.isSingleWordMatch(r,i))return!0;return s.length===1?this.isSingleWordMatch(n,i):!1}static \u0275fac=function(e){return new(e||o)};static \u0275prov=x({token:o,factory:o.\u0275fac,providedIn:"root"})};var W=class o{sightWordStateService=h(P);sightWordProgressService=h(k);wordRecognitionService=h(w);weightIncreaseOnWrong=5;weightDecreaseOnMastered=1;minWeight=1;maxWeight=7;unansweredBonus=3;getNextCard(t,e){if(!t||t.length===0)return null;let n=e?t.filter(l=>l.id!==e):t,i=n.length>0?n:t,s=l=>{let v=l.weight;return l.stats.totalAttempts===0?v+this.unansweredBonus:v},r=i.reduce((l,v)=>l+s(v),0);if(r===0)return i[Math.floor(Math.random()*i.length)];let a=Math.random()*r,p=0;for(let l of i)if(p+=s(l),a<p)return l;return i[i.length-1]}submitAnswer(t,e,n){let i=this.sightWordStateService.getCardById(t);if(!i)throw new Error(`Card with id ${t} not found`);let s=this.sightWordStateService.getSpeedThresholdMs(),r=this.wordRecognitionService.isWordMatch(e,i.word),a=r&&n<s,p=r&&n>=s,l=i.weight;r?a?l=i.weight-this.weightDecreaseOnMastered:p&&(l=i.weight+1):l=i.weight+this.weightIncreaseOnWrong,l=Math.max(this.minWeight,Math.min(this.maxWeight,l));let v={totalAttempts:i.stats.totalAttempts+1,correctAttempts:r?i.stats.correctAttempts+1:i.stats.correctAttempts,fastAttempts:a?i.stats.fastAttempts+1:i.stats.fastAttempts,slowAttempts:p?i.stats.slowAttempts+1:i.stats.slowAttempts,incorrectAttempts:r?i.stats.incorrectAttempts:i.stats.incorrectAttempts+1},L=r?i.consecutiveCorrect+1:0;if(this.sightWordStateService.updateCard(t,{weight:l,lastDurationMs:n,consecutiveCorrect:L,stats:v}),a){let y=this.sightWordStateService.currentLevel();y&&this.sightWordProgressService.recordWordLevelMastery(t,y)}return this.updateSessionStats(r,a,p,n),{isCorrect:r,isFast:a,isSlow:p,newWeight:l}}updateSessionStats(t,e,n,i){let s=this.sightWordStateService.currentSessionStats();if(!s)return;let r=s.totalQuestions+1,a=t?s.correctAnswers+1:s.correctAnswers,p=e?s.fastAnswers+1:s.fastAnswers,l=n?s.slowAnswers+1:s.slowAnswers,v=t?s.incorrectAnswers:s.incorrectAnswers+1,y=(s.averageTimeMs*s.totalQuestions+i)/r;this.sightWordStateService.currentSessionStats.set(D(A({},s),{totalQuestions:r,correctAnswers:a,fastAnswers:p,slowAnswers:l,incorrectAnswers:v,averageTimeMs:y}))}getSpeedThresholdMs(){return this.sightWordStateService.getSpeedThresholdMs()}static \u0275fac=function(e){return new(e||o)};static \u0275prov=x({token:o,factory:o.\u0275fac,providedIn:"root"})};var O=class o{recognition=null;isListening=!1;isSupported(){return"webkitSpeechRecognition"in window||"SpeechRecognition"in window}startListening(t,e,n,i){if(!this.isSupported()){n(new Error("Speech recognition is not supported in this browser"));return}this.isListening&&this.stopListening();let s=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new s,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.lang="af-ZA",this.recognition.maxAlternatives=1,this.recognition.onresult=r=>{if(r.results.length>0){let a=r.results[r.results.length-1],p=a[0].transcript.trim();a.isFinal?e(p):i&&i(p)}},this.recognition.onerror=r=>{let a=r.error;a!=="no-speech"&&a!=="aborted"&&n(new Error(`Speech recognition error: ${a}`))},this.recognition.onend=()=>{if(this.isListening)try{this.recognition.start()}catch{}};try{this.recognition.start(),this.isListening=!0}catch{n(new Error("Failed to start speech recognition. Please check microphone permissions."))}}stopListening(){if(this.recognition&&this.isListening){this.isListening=!1;try{this.recognition.stop()}catch{}this.recognition=null}}getListeningState(){return this.isListening}static \u0275fac=function(e){return new(e||o)};static \u0275prov=x({token:o,factory:o.\u0275fac,providedIn:"root"})};function Q(o,t){if(o&1&&(d(0,"span",12),m(1),c()),o&2){let e=S();_("warning",e.remainingSeconds()<=10)("critical",e.remainingSeconds()<=5),g(),M(" ",e.formatTime(e.remainingSeconds())," ")}}function U(o,t){if(o&1&&I(0,"app-progress-indicator",9),o&2){let e=S();z("cards",e.getCardsWithProgress())("setId",e.currentSet().id)("showProgressBar",!0)("currentLevelId",e.currentLevel())("appType","sight-word")}}function Z(o,t){o&1&&(d(0,"div",16)(1,"div",22)(2,"span",23),m(3,"\u{1F3A4}"),c(),d(4,"div",24),I(5,"span",25)(6,"span",25)(7,"span",25),c()(),d(8,"span",26),m(9,"Listening..."),c()())}function G(o,t){if(o&1&&(d(0,"div",17)(1,"span",27),m(2,"Hearing:"),c(),d(3,"span",28),m(4),c()()),o&2){let e=S(2);g(4),C(e.interimTranscript())}}function J(o,t){if(o&1&&(d(0,"div",18)(1,"span",27),m(2,"Heard:"),c(),d(3,"span",28),m(4),c()()),o&2){let e=S(2);g(4),C(e.finalTranscript())}}function K(o,t){o&1&&(d(0,"div",19)(1,"span",29),m(2,"\u2713"),c(),d(3,"span",30),m(4,"Correct!"),c()())}function V(o,t){o&1&&(d(0,"div",20)(1,"span",31),m(2,"\u{1F422}"),c(),d(3,"span",32),m(4,"Too slow!"),c()())}function X(o,t){if(o&1&&(d(0,"span",34),m(1),c()),o&2){let e=S(3);g(),M('(Heard: "',e.finalTranscript(),'")')}}function Y(o,t){if(o&1&&(d(0,"div",21)(1,"span",33),m(2,"Try again"),c(),f(3,X,2,1,"span",34),c()),o&2){let e=S(2);g(3),u(e.finalTranscript()?3:-1)}}function ee(o,t){if(o&1&&(d(0,"div",13)(1,"div",14)(2,"p",15),m(3),c(),f(4,Z,10,0,"div",16),f(5,G,5,1,"div",17),f(6,J,5,1,"div",18),f(7,K,5,0,"div",19),f(8,V,5,0,"div",20),f(9,Y,4,1,"div",21),c()()),o&2){let e=S();_("correct-feedback",e.feedback()==="correct")("incorrect-feedback",e.feedback()==="incorrect")("slow-feedback",e.feedback()==="slow"),g(3),C(e.currentCard().word),g(),u(e.isListening()?4:-1),g(),u(e.interimTranscript()?5:-1),g(),u(e.finalTranscript()&&!e.isListening()?6:-1),g(),u(e.feedback()==="correct"?7:-1),g(),u(e.feedback()==="slow"?8:-1),g(),u(e.feedback()==="incorrect"?9:-1)}}function te(o,t){o&1&&(d(0,"div",11),m(1,"Loading..."),c())}var H=class o{sightWordStateService=h(P);exerciseEngine=h(W);sightWordProgressService=h(k);speechRecognitionService=h(O);wordRecognitionService=h(w);router=h(B);route=h(j);currentSet=this.sightWordStateService.currentSet;currentCard=b(null);feedback=b("none");questionStartTime=b(0);isListening=b(!1);interimTranscript=b("");finalTranscript=b("");remainingSeconds=b(0);timerIntervalId=null;currentMode=this.sightWordStateService.currentMode;currentLevel=this.sightWordStateService.currentLevel;currentTimedDuration=this.sightWordStateService.currentTimedDuration;isTimedMode=T(()=>this.currentMode()==="timed");levelName=T(()=>q(this.currentLevel()).name);getCardsWithProgress=T(()=>{let t=this.currentSet();return t?this.sightWordStateService.getCardsWithProgress(t):[]});feedbackTimeoutId=null;currentSetId=null;isLoadingNextCard=!1;hasProcessedAnswer=!1;constructor(){R(()=>{let t=this.currentSet();t&&t.cards.length>0&&this.currentSetId!==t.id&&(this.currentSetId=t.id,this.loadNextCard())})}ngOnInit(){let t=this.route.snapshot.paramMap.get("setId");if(t){if(this.sightWordStateService.setCurrentSet(t),this.sightWordStateService.startSession(),this.isTimedMode()){let e=this.currentTimedDuration();e&&(this.remainingSeconds.set(e),this.startTimer())}}else this.router.navigate(["/afrikaans/sigwoorde"])}ngOnDestroy(){this.clearTimeouts(),this.stopTimer(),this.speechRecognitionService.stopListening()}startTimer(){this.timerIntervalId=window.setInterval(()=>{this.remainingSeconds()<=1?(this.remainingSeconds.set(0),this.stopTimer(),this.endSession()):this.remainingSeconds.update(e=>e-1)},1e3)}stopTimer(){this.timerIntervalId!==null&&(clearInterval(this.timerIntervalId),this.timerIntervalId=null)}formatTime(t){let e=Math.floor(t/60),n=t%60;return e>0?`${e}:${n.toString().padStart(2,"0")}`:`${n}s`}loadNextCard(){if(this.isLoadingNextCard)return;this.isLoadingNextCard=!0;let t=this.currentSet();if(!t){this.isLoadingNextCard=!1;return}this.speechRecognitionService.stopListening();let e=this.sightWordStateService.getCardsWithProgress(t),n=this.currentCard()?.id,i=this.exerciseEngine.getNextCard(e,n);i&&(this.currentCard.set(i),this.feedback.set("none"),this.questionStartTime.set(Date.now()),this.interimTranscript.set(""),this.finalTranscript.set(""),this.hasProcessedAnswer=!1,this.startListening(i.word)),this.isLoadingNextCard=!1}startListening(t){if(!this.speechRecognitionService.isSupported()){alert("Speech recognition is not supported in your browser. Please use Chrome or Edge.");return}this.isListening.set(!0),this.interimTranscript.set(""),this.finalTranscript.set(""),this.speechRecognitionService.startListening(t,e=>{this.hasProcessedAnswer||(this.finalTranscript.set(e),this.interimTranscript.set(""),this.handleSpeechResult(e,t))},e=>{console.error("Speech recognition error:",e),e.message.includes("permission")&&(alert("Microphone permission is required. Please allow microphone access and refresh the page."),this.isListening.set(!1))},e=>{this.interimTranscript.set(e),this.hasProcessedAnswer||this.currentCard()&&this.wordRecognitionService.isWordMatch(e,t)&&(this.finalTranscript.set(e),this.interimTranscript.set(""),this.handleSpeechResult(e,t))})}handleSpeechResult(t,e){if(this.hasProcessedAnswer)return;let n=this.currentCard();if(!n)return;let i=Date.now()-this.questionStartTime(),s=this.exerciseEngine.submitAnswer(n.id,t,i);s.isCorrect?(this.hasProcessedAnswer=!0,this.speechRecognitionService.stopListening(),this.isListening.set(!1),this.interimTranscript.set(""),s.isFast?this.feedback.set("correct"):s.isSlow?this.feedback.set("slow"):this.feedback.set("correct"),this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.finalTranscript.set(""),s.isFast&&this.currentMode()==="master"&&this.isSetMasteredAtCurrentLevel()?this.endSession():this.loadNextCard()},1500)):(this.feedback.set("incorrect"),this.interimTranscript.set(""),this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.finalTranscript.set("")},2e3))}endSession(){this.clearTimeouts(),this.stopTimer(),this.speechRecognitionService.stopListening(),this.isListening.set(!1),this.currentMode()==="master"&&this.checkAndRecordMastery(),this.sightWordStateService.endSession(),this.router.navigate(["/afrikaans/sigwoorde/summary"])}isSetMasteredAtCurrentLevel(){let t=this.currentSet(),e=this.currentLevel();return!t||!e?!1:this.sightWordStateService.getCardsWithProgress(t).every(i=>this.sightWordProgressService.isWordMasteredAtLevel(i.id,e))}checkAndRecordMastery(){let t=this.currentSet(),e=this.currentLevel();!t||!e||this.isSetMasteredAtCurrentLevel()&&this.sightWordProgressService.recordSetMastery(t.id,e)}clearTimeouts(){this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)}static \u0275fac=function(e){return new(e||o)};static \u0275cmp=N({type:o,selectors:[["app-afrikaans-exercise"]],decls:15,vars:7,consts:[[1,"exercise-container"],[1,"exercise-header"],["type","button","aria-label","Exit session",1,"exit-button",3,"click"],[1,"header-content"],[1,"header-row"],[1,"set-name"],[1,"header-badges"],[1,"level-badge"],["aria-live","polite",1,"timer-badge",3,"warning","critical"],[3,"cards","setId","showProgressBar","currentLevelId","appType"],[1,"word-container",3,"correct-feedback","incorrect-feedback","slow-feedback"],[1,"loading"],["aria-live","polite",1,"timer-badge"],[1,"word-container"],[1,"word-display"],[1,"word-text"],["aria-live","polite",1,"listening-indicator"],["aria-live","polite",1,"transcript-display","interim"],["aria-live","polite",1,"transcript-display","final"],["aria-live","polite",1,"correct-indicator"],["aria-live","polite",1,"slow-indicator"],["aria-live","polite",1,"incorrect-indicator"],[1,"mic-container"],[1,"mic-icon"],[1,"sound-waves"],[1,"wave"],[1,"listening-text"],[1,"transcript-label"],[1,"transcript-text"],[1,"check-icon"],[1,"correct-text"],[1,"turtle-icon"],[1,"slow-text"],[1,"try-again-text"],[1,"heard-text"]],template:function(e,n){if(e&1&&(d(0,"div",0)(1,"header",1)(2,"button",2),F("click",function(){return n.endSession()}),m(3," \u2715 "),c(),d(4,"div",3)(5,"div",4)(6,"h2",5),m(7),c(),d(8,"div",6)(9,"span",7),m(10),c(),f(11,Q,2,5,"span",8),c()(),f(12,U,1,5,"app-progress-indicator",9),c()(),f(13,ee,10,13,"div",10)(14,te,2,0,"div",11),c()),e&2){let i;g(7),C((i=n.currentSet())==null?null:i.name),g(2),_("ninja",n.currentLevel()==="ninja"),g(),M(" ",n.levelName()," "),g(),u(n.isTimedMode()?11:-1),g(),u(n.currentSet()&&!n.isTimedMode()?12:-1),g(),u(n.currentCard()?13:14)}},dependencies:[$],styles:[".exercise-container[_ngcontent-%COMP%]{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;background:var(--bg-primary, #fff);color:var(--text-primary, #333)}.exercise-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border-color, #e0e0e0);gap:1rem}.header-content[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.75rem;min-width:0}.exit-button[_ngcontent-%COMP%]{width:44px;height:44px;border:none;background:transparent;font-size:1.5rem;color:var(--text-primary, #333);cursor:pointer;border-radius:.5rem;transition:background .2s ease}.exit-button[_ngcontent-%COMP%]:hover{background:var(--button-hover-bg, #f0f0f0)}.set-name[_ngcontent-%COMP%]{font-size:clamp(1rem,2.5vw,1.25rem);margin:0;color:var(--text-secondary, #666)}.header-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:.5rem}.header-badges[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.level-badge[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600;padding:.25rem .5rem;border-radius:.25rem;background:var(--level-bg, #e0e0e0);color:var(--level-text, #333)}.level-badge.ninja[_ngcontent-%COMP%]{background:linear-gradient(135deg,#1a1a1a,#333);color:#fff}.timer-badge[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;padding:.25rem .75rem;border-radius:.25rem;background:var(--timer-bg, #2196f3);color:var(--timer-text, #fff);min-width:60px;text-align:center;font-variant-numeric:tabular-nums}.timer-badge.warning[_ngcontent-%COMP%]{background:var(--timer-warning, #ff9800);animation:_ngcontent-%COMP%_timerPulse 1s infinite}.timer-badge.critical[_ngcontent-%COMP%]{background:var(--timer-critical, #f44336);animation:_ngcontent-%COMP%_timerPulse .5s infinite}@keyframes _ngcontent-%COMP%_timerPulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}.header-content[_ngcontent-%COMP%]   app-progress-indicator[_ngcontent-%COMP%]{width:100%}.word-container[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem;transition:background-color .3s ease}.word-container.correct-feedback[_ngcontent-%COMP%]{background-color:var(--correct-bg, #e8f5e9)}.word-container.incorrect-feedback[_ngcontent-%COMP%]{background-color:var(--incorrect-bg, #ffebee)}.word-container.slow-feedback[_ngcontent-%COMP%]{background-color:var(--slow-bg, #fff3e0)}.word-display[_ngcontent-%COMP%]{text-align:center;display:flex;flex-direction:column;align-items:center;gap:2rem}.word-text[_ngcontent-%COMP%]{font-size:clamp(4rem,15vw,8rem);font-weight:700;margin:0;color:var(--text-primary, #333);line-height:1.2}.listening-indicator[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.75rem;padding:1rem 1.5rem;background:var(--listening-bg, #fff3e0);border:2px solid var(--app-afrikaans-accent, #FF9800);border-radius:2rem;font-size:1rem;font-weight:600;color:var(--app-afrikaans-accent, #FF9800)}.mic-container[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.75rem}.mic-icon[_ngcontent-%COMP%]{font-size:1.5rem;animation:_ngcontent-%COMP%_pulse 1.5s infinite}.sound-waves[_ngcontent-%COMP%]{display:flex;gap:.25rem;align-items:center}.wave[_ngcontent-%COMP%]{width:4px;height:20px;background:var(--app-afrikaans-accent, #FF9800);border-radius:2px;animation:_ngcontent-%COMP%_wave 1s infinite}.wave[_ngcontent-%COMP%]:nth-child(1){animation-delay:0s}.wave[_ngcontent-%COMP%]:nth-child(2){animation-delay:.2s}.wave[_ngcontent-%COMP%]:nth-child(3){animation-delay:.4s}@keyframes _ngcontent-%COMP%_pulse{0%,to{opacity:1;transform:scale(1)}50%{opacity:.7;transform:scale(1.1)}}@keyframes _ngcontent-%COMP%_wave{0%,to{height:10px;opacity:.5}50%{height:24px;opacity:1}}.transcript-display[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:1rem 1.5rem;background:var(--transcript-bg, #f5f5f5);border:2px solid var(--transcript-border, #ddd);border-radius:1rem;max-width:90%;min-width:200px}.transcript-display.interim[_ngcontent-%COMP%]{border-color:var(--app-afrikaans-accent, #FF9800);background:var(--transcript-interim-bg, #fff3e0)}.transcript-display.final[_ngcontent-%COMP%]{border-color:var(--transcript-final-border, #999);background:var(--transcript-final-bg, #e0e0e0)}.transcript-label[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary, #666)}.transcript-text[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:600;color:var(--text-primary, #333);text-align:center;word-break:break-word}.transcript-display.interim[_ngcontent-%COMP%]   .transcript-text[_ngcontent-%COMP%]{color:var(--app-afrikaans-accent, #FF9800);font-style:italic}.correct-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:var(--correct-indicator-bg, #4caf50);border-radius:2rem;font-size:1.25rem;font-weight:700;color:#fff}.check-icon[_ngcontent-%COMP%]{font-size:1.5rem}.incorrect-indicator[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem;padding:.75rem 1.5rem;background:var(--incorrect-indicator-bg, #f44336);border-radius:2rem;font-size:1rem;font-weight:600;color:#fff}.heard-text[_ngcontent-%COMP%]{font-size:.875rem;opacity:.9;font-weight:400}.loading[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--text-secondary, #666)}@media(prefers-color-scheme:dark){.exercise-container[_ngcontent-%COMP%]{--bg-primary: #1a1a1a;--text-primary: #fff;--text-secondary: #aaa;--border-color: #444;--button-hover-bg: #333;--level-bg: #444;--level-text: #fff;--timer-bg: #2196f3;--timer-text: #fff;--timer-warning: #ff9800;--timer-critical: #f44336;--correct-bg: #2e7d32;--incorrect-bg: #b71c1c;--slow-bg: #e65100;--listening-bg: #3e2723;--correct-indicator-bg: #4caf50;--incorrect-indicator-bg: #f44336;--slow-indicator-bg: #ff9800;--transcript-bg: #2a2a2a;--transcript-border: #555;--transcript-interim-bg: #3e2723;--transcript-final-bg: #333;--transcript-final-border: #666}}"],changeDetection:0})};export{H as ExerciseComponent};

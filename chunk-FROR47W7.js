import{g as S,j as v,o as d,p}from"./chunk-FYXY47SE.js";import{a as n,b as c}from"./chunk-2NFLSA4Y.js";var h=[{id:"level1",name:"Level 1",speedThresholdMs:1e4},{id:"level2",name:"Level 2",speedThresholdMs:6e3},{id:"level3",name:"Level 3",speedThresholdMs:3e3},{id:"ninja",name:"Ninja",speedThresholdMs:1500}];function M(o){return h.find(e=>e.id===o)??h[0]}var x="school-helper-users",C="school-helper-current-user",U="Default",f=class o{users=d([]);currentUser=d(null);constructor(){this.initializeUsers(),p(()=>{let e=this.currentUser();e?localStorage.setItem(C,e):localStorage.removeItem(C)})}initializeUsers(){let e=this.loadUsers(),t=localStorage.getItem(C);if(e.length===0){let r={name:U,createdAt:new Date};this.users.set([r]),this.currentUser.set(U),this.saveUsers()}else{this.users.set(e);let r=t||e[0].name;e.some(s=>s.name===r)?this.currentUser.set(r):this.currentUser.set(e[0].name)}}loadUsers(){try{let e=localStorage.getItem(x);return e?JSON.parse(e).map(r=>c(n({},r),{createdAt:new Date(r.createdAt)})):[]}catch(e){return console.error("Error loading users from localStorage:",e),[]}}saveUsers(){try{let e=this.users().map(t=>c(n({},t),{createdAt:t.createdAt.toISOString()}));localStorage.setItem(x,JSON.stringify(e))}catch(e){console.error("Error saving users to localStorage:",e)}}createUser(e){let t=e.trim();if(!t||this.users().some(s=>s.name===t))return!1;let r={name:t,createdAt:new Date};return this.users.set([...this.users(),r]),this.saveUsers(),!0}switchUser(e){return this.users().some(r=>r.name===e)?(this.currentUser.set(e),!0):!1}deleteUser(e){if(e===U&&this.users().length===1)return!1;let t=this.users().filter(r=>r.name!==e);return t.length===this.users().length?!1:(this.users.set(t),this.saveUsers(),this.currentUser()===e&&this.currentUser.set(t[0].name),!0)}getCurrentUserName(){return this.currentUser()}static \u0275fac=function(t){return new(t||o)};static \u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"})};var b="school-helper-user-",w="-progress",D="-mastery",y=class o{userService=v(f);progressCache=new Map;masteryCache=new Map;progressUpdateTrigger=d(0);masteryUpdateTrigger=d(0);constructor(){this.migrateExistingData(),p(()=>{let e=this.userService.currentUser();e&&(this.loadProgressForUser(e),this.loadMasteryForUser(e))})}migrateExistingData(){let e="school-helper-migration-completed";if(!localStorage.getItem(e))try{let t="school-helper-math-sets",r=localStorage.getItem(t);if(r){let s=JSON.parse(r);if(Array.isArray(s)&&s.length>0){let a=s[0];if(a.cards&&Array.isArray(a.cards)&&a.cards.length>0){let i=a.cards[0];if(i.weight!==void 0||i.stats!==void 0){let m="Default",g={};for(let u of s)if(u.cards&&Array.isArray(u.cards))for(let l of u.cards)l.id&&(l.weight!==void 0||l.stats!==void 0)&&(g[l.id]={weight:l.weight??1,consecutiveCorrect:l.consecutiveCorrect??0,lastDurationMs:l.lastDurationMs,stats:l.stats??{totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0}});Object.keys(g).length>0&&this.saveProgressForUser(m,g);let L=s.map(u=>({id:u.id,name:u.name,cards:u.cards.map(l=>({id:l.id,question:l.question,answer:l.answer})),createdAt:u.createdAt,updatedAt:u.updatedAt}));localStorage.setItem(t,JSON.stringify(L))}}}}localStorage.setItem(e,"true")}catch(t){console.error("Error during data migration:",t)}}getCardProgress(e){return this.userService.getCurrentUserName()&&this.getProgressForCurrentUser()[e]||null}updateCardProgress(e,t){let r=this.userService.getCurrentUserName();if(!r)return;let s=this.getProgressForCurrentUser(),a=s[e];a?s[e]=c(n(n({},a),t),{stats:n(n({},a.stats),t.stats||{}),masteredAtLevels:t.masteredAtLevels??a.masteredAtLevels}):s[e]=c(n({weight:1,consecutiveCorrect:0},t),{stats:n({totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0},t.stats||{}),masteredAtLevels:t.masteredAtLevels??[]}),this.saveProgressForUser(r,s),this.progressUpdateTrigger.update(i=>i+1)}recordCardLevelMastery(e,t){let r=this.userService.getCurrentUserName();if(!r)return;let s=this.getProgressForCurrentUser(),a=s[e];if(!a)return;let i=a.masteredAtLevels??[];i.includes(t)||(s[e]=c(n({},a),{masteredAtLevels:[...i,t]}),this.saveProgressForUser(r,s),this.progressUpdateTrigger.update(m=>m+1))}isCardMasteredAtLevel(e,t){let r=this.getCardProgress(e);return r?r.masteredAtLevels?.includes(t)??!1:!1}getCardsMasteredAtLevelCount(e,t){return e.filter(r=>this.isCardMasteredAtLevel(r,t)).length}getProgressForCurrentUser(){let e=this.userService.getCurrentUserName();return e?this.loadProgressForUser(e):{}}loadProgressForUser(e){if(this.progressCache.has(e))return this.progressCache.get(e);try{let t=this.getStorageKey(e),r=localStorage.getItem(t);if(!r){let a={};return this.progressCache.set(e,a),a}let s=JSON.parse(r);return this.progressCache.set(e,s),s}catch(t){console.error(`Error loading progress for user ${e}:`,t);let r={};return this.progressCache.set(e,r),r}}saveProgressForUser(e,t){try{let r=this.getStorageKey(e);localStorage.setItem(r,JSON.stringify(t)),this.progressCache.set(e,t)}catch(r){console.error(`Error saving progress for user ${e}:`,r)}}getStorageKey(e){return`${b}${e}${w}`}clearCache(){this.progressCache.clear()}initializeUserProgress(e){let t={};this.saveProgressForUser(e,t)}deleteUserProgress(e){try{let t=this.getStorageKey(e);localStorage.removeItem(t),this.progressCache.delete(e)}catch(t){console.error(`Error deleting progress for user ${e}:`,t)}}resetSetProgress(e){let t=this.userService.getCurrentUserName();if(!t)return;let r=this.getProgressForCurrentUser(),s=!1;for(let a of e)r[a]&&(delete r[a],s=!0);s&&(this.saveProgressForUser(t,r),this.progressUpdateTrigger.update(a=>a+1))}resetSetProgressAndMastery(e,t){this.resetSetProgress(t),this.resetSetMastery(e)}getMasteryStorageKey(e){return`${b}${e}${D}`}loadMasteryForUser(e){if(this.masteryCache.has(e))return this.masteryCache.get(e);try{let t=this.getMasteryStorageKey(e),r=localStorage.getItem(t);if(!r){let a={};return this.masteryCache.set(e,a),a}let s=JSON.parse(r);return this.masteryCache.set(e,s),s}catch(t){console.error(`Error loading mastery for user ${e}:`,t);let r={};return this.masteryCache.set(e,r),r}}saveMasteryForUser(e,t){try{let r=this.getMasteryStorageKey(e);localStorage.setItem(r,JSON.stringify(t)),this.masteryCache.set(e,t)}catch(r){console.error(`Error saving mastery for user ${e}:`,r)}}getSetMastery(e){let t=this.userService.getCurrentUserName();return t?(this.masteryUpdateTrigger(),this.loadMasteryForUser(t)[e]??null):null}getMasteryStars(e){let t=this.getSetMastery(e);if(!t)return 0;let r=h.findIndex(s=>s.id===t);return r>=0?r+1:0}isLevelUnlocked(e,t){let r=h.findIndex(i=>i.id===t);if(r===0)return!0;let s=this.getSetMastery(e);return s?h.findIndex(i=>i.id===s)>=r-1:!1}recordSetMastery(e,t){let r=this.userService.getCurrentUserName();if(!r)return;let s=this.loadMasteryForUser(r),a=s[e],i=h.findIndex(g=>g.id===t),m=a?h.findIndex(g=>g.id===a):-1;i>m&&(s[e]=t,this.saveMasteryForUser(r,s),this.masteryUpdateTrigger.update(g=>g+1))}resetSetMastery(e){let t=this.userService.getCurrentUserName();if(!t)return;let r=this.loadMasteryForUser(t);r[e]&&(delete r[e],this.saveMasteryForUser(t,r),this.masteryUpdateTrigger.update(s=>s+1))}deleteUserMastery(e){try{let t=this.getMasteryStorageKey(e);localStorage.removeItem(t),this.masteryCache.delete(e)}catch(t){console.error(`Error deleting mastery for user ${e}:`,t)}}static \u0275fac=function(t){return new(t||o)};static \u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"})};var I="school-helper-math-sets",P=class o{userProgressService=v(y);defaultWeight=1;availableSets=d([]);currentSet=d(null);currentSessionStats=d(null);currentMode=d("master");currentTimedDuration=d(null);currentLevel=d("level1");getSpeedThresholdMs(){return M(this.currentLevel()).speedThresholdMs}constructor(){let e=this.loadFromLocalStorage(),t=this.createMockSets(),r=e.length>0?this.mergeSets(e,t):t;this.availableSets.set(r),p(()=>{let s=this.availableSets();this.saveToLocalStorage(s)})}loadFromLocalStorage(){try{let e=localStorage.getItem(I);return e?JSON.parse(e).map(r=>c(n({},r),{cards:r.cards,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt)})):[]}catch(e){return console.error("Error loading math sets from localStorage:",e),[]}}saveToLocalStorage(e){try{let t=e.map(r=>({id:r.id,name:r.name,cards:r.cards.map(s=>({id:s.id,question:s.question,answer:s.answer})),createdAt:r.createdAt.toISOString(),updatedAt:r.updatedAt.toISOString()}));localStorage.setItem(I,JSON.stringify(t))}catch(t){console.error("Error saving math sets to localStorage:",t)}}mergeSets(e,t){let r=new Set(e.map(a=>a.id)),s=t.filter(a=>!r.has(a.id));return[...e,...s]}createMockSets(){let e=new Date,t=[this.createCard("3x1","3 x 1",3),this.createCard("3x2","3 x 2",6),this.createCard("3x3","3 x 3",9),this.createCard("3x4","3 x 4",12),this.createCard("3x5","3 x 5",15),this.createCard("3x6","3 x 6",18),this.createCard("3x7","3 x 7",21),this.createCard("3x8","3 x 8",24),this.createCard("3x9","3 x 9",27),this.createCard("3x10","3 x 10",30)],r=[this.createCard("4x1","4 x 1",4),this.createCard("4x2","4 x 2",8),this.createCard("4x3","4 x 3",12),this.createCard("4x4","4 x 4",16),this.createCard("4x5","4 x 5",20),this.createCard("4x6","4 x 6",24),this.createCard("4x7","4 x 7",28),this.createCard("4x8","4 x 8",32),this.createCard("4x9","4 x 9",36),this.createCard("4x10","4 x 10",40)],s=[this.createCard("8x1","8 x 1",8),this.createCard("8x2","8 x 2",16),this.createCard("8x3","8 x 3",24),this.createCard("8x4","8 x 4",32),this.createCard("8x5","8 x 5",40),this.createCard("8x6","8 x 6",48),this.createCard("8x7","8 x 7",56),this.createCard("8x8","8 x 8",64),this.createCard("8x9","8 x 9",72),this.createCard("8x10","8 x 10",80)];return[{id:"mult-3s",name:"Multiplication 3s",cards:t,createdAt:e,updatedAt:e},{id:"mult-4s",name:"Multiplication 4s",cards:r,createdAt:e,updatedAt:e},{id:"mult-8s",name:"Multiplication 8s",cards:s,createdAt:e,updatedAt:e}]}createCard(e,t,r){return{id:e,question:t,answer:r}}mergeCardWithProgress(e){this.userProgressService.progressUpdateTrigger();let t=this.userProgressService.getCardProgress(e.id);return t?c(n({},e),{weight:t.weight,consecutiveCorrect:t.consecutiveCorrect,lastDurationMs:t.lastDurationMs,stats:t.stats}):c(n({},e),{weight:this.defaultWeight,consecutiveCorrect:0,stats:{totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0}})}getCardsWithProgress(e){return e.cards.map(t=>this.mergeCardWithProgress(t))}setCurrentSet(e){let t=this.availableSets().find(r=>r.id===e);t&&this.currentSet.set(t)}clearCurrentSet(){this.currentSet.set(null)}setExerciseOptions(e,t,r){this.currentMode.set(e),this.currentLevel.set(t),this.currentTimedDuration.set(r??null)}startSession(){if(!this.currentSet())return;let t={startTime:new Date,totalQuestions:0,correctAnswers:0,fastAnswers:0,slowAnswers:0,incorrectAnswers:0,averageTimeMs:0,mode:this.currentMode(),timedDuration:this.currentTimedDuration()??void 0,level:this.currentLevel()};this.currentSessionStats.set(t)}endSession(){let e=this.currentSessionStats();e&&this.currentSessionStats.set(c(n({},e),{endTime:new Date}))}getCardById(e){let t=this.currentSet();if(!t)return;let r=t.cards.find(s=>s.id===e);if(r)return this.mergeCardWithProgress(r)}updateCard(e,t){this.userProgressService.updateCardProgress(e,{weight:t.weight,consecutiveCorrect:t.consecutiveCorrect,lastDurationMs:t.lastDurationMs,stats:t.stats})}addSet(e){let t=this.availableSets();this.availableSets.set([...t,e])}updateSet(e,t){let s=this.availableSets().map(i=>i.id===e?c(n(n({},i),t),{updatedAt:new Date}):i);this.availableSets.set(s);let a=this.currentSet();if(a&&a.id===e){let i=s.find(m=>m.id===e);i&&this.currentSet.set(i)}}getSetById(e){return this.availableSets().find(t=>t.id===e)}deleteSet(e){let r=this.availableSets().filter(a=>a.id!==e);this.availableSets.set(r);let s=this.currentSet();s&&s.id===e&&this.currentSet.set(null)}resetSetProgress(e){let t=this.getSetById(e);if(!t)return;let r=t.cards.map(s=>s.id);this.userProgressService.resetSetProgressAndMastery(e,r)}static \u0275fac=function(t){return new(t||o)};static \u0275prov=S({token:o,factory:o.\u0275fac,providedIn:"root"})};export{h as a,M as b,f as c,y as d,P as e};

import{a as d,c as f}from"./chunk-WDXSJPWS.js";import{g as p,j as m,o as y,p as v}from"./chunk-FYXY47SE.js";import{a as c,b as h}from"./chunk-2NFLSA4Y.js";var U="school-helper-user-",M="-progress",A="-mastery",S=class u{userService=m(f);progressCache=new Map;masteryCache=new Map;progressUpdateTrigger=y(0);masteryUpdateTrigger=y(0);constructor(){this.migrateExistingData(),v(()=>{let e=this.userService.currentUser();e&&(this.loadProgressForUser(e),this.loadMasteryForUser(e))})}migrateExistingData(){let e="school-helper-migration-completed";if(!localStorage.getItem(e))try{let r="school-helper-math-sets",t=localStorage.getItem(r);if(t){let s=JSON.parse(t);if(Array.isArray(s)&&s.length>0){let o=s[0];if(o.cards&&Array.isArray(o.cards)&&o.cards.length>0){let a=o.cards[0];if(a.weight!==void 0||a.stats!==void 0){let l="Default",i={};for(let g of s)if(g.cards&&Array.isArray(g.cards))for(let n of g.cards)n.id&&(n.weight!==void 0||n.stats!==void 0)&&(i[n.id]={weight:n.weight??1,consecutiveCorrect:n.consecutiveCorrect??0,lastDurationMs:n.lastDurationMs,stats:n.stats??{totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0}});Object.keys(i).length>0&&this.saveProgressForUser(l,i);let C=s.map(g=>({id:g.id,name:g.name,cards:g.cards.map(n=>({id:n.id,question:n.question,answer:n.answer})),createdAt:g.createdAt,updatedAt:g.updatedAt}));localStorage.setItem(r,JSON.stringify(C))}}}}localStorage.setItem(e,"true")}catch(r){console.error("Error during data migration:",r)}}getCardProgress(e){return this.userService.getCurrentUserName()&&this.getProgressForCurrentUser()[e]||null}updateCardProgress(e,r){let t=this.userService.getCurrentUserName();if(!t)return;let s=this.getProgressForCurrentUser(),o=s[e];o?s[e]=h(c(c({},o),r),{stats:c(c({},o.stats),r.stats||{}),masteredAtLevels:r.masteredAtLevels??o.masteredAtLevels}):s[e]=h(c({weight:1,consecutiveCorrect:0},r),{stats:c({totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0},r.stats||{}),masteredAtLevels:r.masteredAtLevels??[]}),this.saveProgressForUser(t,s),this.progressUpdateTrigger.update(a=>a+1)}recordCardLevelMastery(e,r){let t=this.userService.getCurrentUserName();if(!t)return;let s=this.getProgressForCurrentUser(),o=s[e];if(!o)return;let a=o.masteredAtLevels??[];a.includes(r)||(s[e]=h(c({},o),{masteredAtLevels:[...a,r]}),this.saveProgressForUser(t,s),this.progressUpdateTrigger.update(l=>l+1))}isCardMasteredAtLevel(e,r){let t=this.getCardProgress(e);return t?t.masteredAtLevels?.includes(r)??!1:!1}getCardsMasteredAtLevelCount(e,r){return e.filter(t=>this.isCardMasteredAtLevel(t,r)).length}getProgressForCurrentUser(){let e=this.userService.getCurrentUserName();return e?this.loadProgressForUser(e):{}}loadProgressForUser(e){if(this.progressCache.has(e))return this.progressCache.get(e);try{let r=this.getStorageKey(e),t=localStorage.getItem(r);if(!t){let o={};return this.progressCache.set(e,o),o}let s=JSON.parse(t);return this.progressCache.set(e,s),s}catch(r){console.error(`Error loading progress for user ${e}:`,r);let t={};return this.progressCache.set(e,t),t}}saveProgressForUser(e,r){try{let t=this.getStorageKey(e);localStorage.setItem(t,JSON.stringify(r)),this.progressCache.set(e,r)}catch(t){console.error(`Error saving progress for user ${e}:`,t)}}getStorageKey(e){return`${U}${e}${M}`}clearCache(){this.progressCache.clear()}initializeUserProgress(e){let r={};this.saveProgressForUser(e,r)}deleteUserProgress(e){try{let r=this.getStorageKey(e);localStorage.removeItem(r),this.progressCache.delete(e)}catch(r){console.error(`Error deleting progress for user ${e}:`,r)}}resetSetProgress(e){let r=this.userService.getCurrentUserName();if(!r)return;let t=this.getProgressForCurrentUser(),s=!1;for(let o of e)t[o]&&(delete t[o],s=!0);s&&(this.saveProgressForUser(r,t),this.progressUpdateTrigger.update(o=>o+1))}resetSetProgressAndMastery(e,r){this.resetSetProgress(r),this.resetSetMastery(e)}getMasteryStorageKey(e){return`${U}${e}${A}`}loadMasteryForUser(e){if(this.masteryCache.has(e))return this.masteryCache.get(e);try{let r=this.getMasteryStorageKey(e),t=localStorage.getItem(r);if(!t){let o={};return this.masteryCache.set(e,o),o}let s=JSON.parse(t);return this.masteryCache.set(e,s),s}catch(r){console.error(`Error loading mastery for user ${e}:`,r);let t={};return this.masteryCache.set(e,t),t}}saveMasteryForUser(e,r){try{let t=this.getMasteryStorageKey(e);localStorage.setItem(t,JSON.stringify(r)),this.masteryCache.set(e,r)}catch(t){console.error(`Error saving mastery for user ${e}:`,t)}}getSetMastery(e){let r=this.userService.getCurrentUserName();return r?(this.masteryUpdateTrigger(),this.loadMasteryForUser(r)[e]??null):null}getMasteryStars(e){let r=this.getSetMastery(e);if(!r)return 0;let t=d.findIndex(s=>s.id===r);return t>=0?t+1:0}isLevelUnlocked(e,r){let t=d.findIndex(a=>a.id===r);if(t===0)return!0;let s=this.getSetMastery(e);return s?d.findIndex(a=>a.id===s)>=t-1:!1}recordSetMastery(e,r){let t=this.userService.getCurrentUserName();if(!t)return;let s=this.loadMasteryForUser(t),o=s[e],a=d.findIndex(i=>i.id===r),l=o?d.findIndex(i=>i.id===o):-1;a>l&&(s[e]=r,this.saveMasteryForUser(t,s),this.masteryUpdateTrigger.update(i=>i+1))}resetSetMastery(e){let r=this.userService.getCurrentUserName();if(!r)return;let t=this.loadMasteryForUser(r);t[e]&&(delete t[e],this.saveMasteryForUser(r,t),this.masteryUpdateTrigger.update(s=>s+1))}deleteUserMastery(e){try{let r=this.getMasteryStorageKey(e);localStorage.removeItem(r),this.masteryCache.delete(e)}catch(r){console.error(`Error deleting mastery for user ${e}:`,r)}}static \u0275fac=function(r){return new(r||u)};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};export{S as a};

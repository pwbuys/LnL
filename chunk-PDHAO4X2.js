import{a,c as p}from"./chunk-WDXSJPWS.js";import{g as y,j as u,o as l,p as S}from"./chunk-FYXY47SE.js";import{a as n,b as c}from"./chunk-2NFLSA4Y.js";var v="school-helper-user-",m="-sight-word-progress",f="-sight-word-mastery",U=class d{userService=u(p);progressCache=new Map;masteryCache=new Map;progressUpdateTrigger=l(0);masteryUpdateTrigger=l(0);constructor(){S(()=>{let r=this.userService.currentUser();r&&(this.loadProgressForUser(r),this.loadMasteryForUser(r))})}getWordProgress(r){return this.userService.getCurrentUserName()&&this.getProgressForCurrentUser()[r]||null}updateWordProgress(r,e){let t=this.userService.getCurrentUserName();if(!t)return;let s=this.getProgressForCurrentUser(),o=s[r];o?s[r]=c(n(n({},o),e),{stats:n(n({},o.stats),e.stats||{}),masteredAtLevels:e.masteredAtLevels??o.masteredAtLevels}):s[r]=c(n({weight:1,consecutiveCorrect:0},e),{stats:n({totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0},e.stats||{}),masteredAtLevels:e.masteredAtLevels??[]}),this.saveProgressForUser(t,s),this.progressUpdateTrigger.update(i=>i+1)}getProgressForCurrentUser(){let r=this.userService.getCurrentUserName();return r?this.loadProgressForUser(r):{}}loadProgressForUser(r){if(this.progressCache.has(r))return this.progressCache.get(r);try{let e=this.getProgressStorageKey(r),t=localStorage.getItem(e);if(!t){let o={};return this.progressCache.set(r,o),o}let s=JSON.parse(t);return this.progressCache.set(r,s),s}catch(e){console.error(`Error loading sight word progress for user ${r}:`,e);let t={};return this.progressCache.set(r,t),t}}saveProgressForUser(r,e){try{let t=this.getProgressStorageKey(r);localStorage.setItem(t,JSON.stringify(e)),this.progressCache.set(r,e)}catch(t){console.error(`Error saving sight word progress for user ${r}:`,t)}}getProgressStorageKey(r){return`${v}${r}${m}`}clearCache(){this.progressCache.clear()}initializeUserProgress(r){let e={};this.saveProgressForUser(r,e)}deleteUserProgress(r){try{let e=this.getProgressStorageKey(r);localStorage.removeItem(e),this.progressCache.delete(r)}catch(e){console.error(`Error deleting sight word progress for user ${r}:`,e)}}resetSetProgress(r){let e=this.userService.getCurrentUserName();if(!e)return;let t=this.getProgressForCurrentUser(),s=!1;for(let o of r)t[o]&&(delete t[o],s=!0);s&&(this.saveProgressForUser(e,t),this.progressUpdateTrigger.update(o=>o+1))}resetSetProgressAndMastery(r,e){this.resetSetProgress(e),this.resetSetMastery(r)}getMasteryStorageKey(r){return`${v}${r}${f}`}loadMasteryForUser(r){if(this.masteryCache.has(r))return this.masteryCache.get(r);try{let e=this.getMasteryStorageKey(r),t=localStorage.getItem(e);if(!t){let o={};return this.masteryCache.set(r,o),o}let s=JSON.parse(t);return this.masteryCache.set(r,s),s}catch(e){console.error(`Error loading sight word mastery for user ${r}:`,e);let t={};return this.masteryCache.set(r,t),t}}saveMasteryForUser(r,e){try{let t=this.getMasteryStorageKey(r);localStorage.setItem(t,JSON.stringify(e)),this.masteryCache.set(r,e)}catch(t){console.error(`Error saving sight word mastery for user ${r}:`,t)}}getSetMastery(r){let e=this.userService.getCurrentUserName();return e?(this.masteryUpdateTrigger(),this.loadMasteryForUser(e)[r]??null):null}getMasteryStars(r){let e=this.getSetMastery(r);if(!e)return 0;let t=a.findIndex(s=>s.id===e);return t>=0?t+1:0}isLevelUnlocked(r,e){let t=a.findIndex(i=>i.id===e);if(t===0)return!0;let s=this.getSetMastery(r);return s?a.findIndex(i=>i.id===s)>=t-1:!1}recordSetMastery(r,e){let t=this.userService.getCurrentUserName();if(!t)return;let s=this.loadMasteryForUser(t),o=s[r],i=a.findIndex(g=>g.id===e),h=o?a.findIndex(g=>g.id===o):-1;i>h&&(s[r]=e,this.saveMasteryForUser(t,s),this.masteryUpdateTrigger.update(g=>g+1))}resetSetMastery(r){let e=this.userService.getCurrentUserName();if(!e)return;let t=this.loadMasteryForUser(e);t[r]&&(delete t[r],this.saveMasteryForUser(e,t),this.masteryUpdateTrigger.update(s=>s+1))}deleteUserMastery(r){try{let e=this.getMasteryStorageKey(r);localStorage.removeItem(e),this.masteryCache.delete(r)}catch(e){console.error(`Error deleting sight word mastery for user ${r}:`,e)}}recordWordLevelMastery(r,e){let t=this.userService.getCurrentUserName();if(!t)return;let s=this.getProgressForCurrentUser(),o=s[r];if(!o)return;let i=o.masteredAtLevels??[];i.includes(e)||(s[r]=c(n({},o),{masteredAtLevels:[...i,e]}),this.saveProgressForUser(t,s),this.progressUpdateTrigger.update(h=>h+1))}isWordMasteredAtLevel(r,e){let t=this.getWordProgress(r);return t?t.masteredAtLevels?.includes(e)??!1:!1}getWordsMasteredAtLevelCount(r,e){return r.filter(t=>this.isWordMasteredAtLevel(t,e)).length}static \u0275fac=function(e){return new(e||d)};static \u0275prov=y({token:d,factory:d.\u0275fac,providedIn:"root"})};export{U as a};

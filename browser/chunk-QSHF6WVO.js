import{a as C}from"./chunk-67XDVZMU.js";import{g as h,j as u,o as l,p as S}from"./chunk-YKW7H7HN.js";import{a as o,b as d}from"./chunk-2NFLSA4Y.js";var U="school-helper-user-",y="-progress",p=class g{userService=u(C);progressCache=new Map;progressUpdateTrigger=l(0);constructor(){this.migrateExistingData(),S(()=>{let t=this.userService.currentUser();t&&this.loadProgressForUser(t)})}migrateExistingData(){let t="school-helper-migration-completed";if(!localStorage.getItem(t))try{let e="school-helper-math-sets",r=localStorage.getItem(e);if(r){let s=JSON.parse(r);if(Array.isArray(s)&&s.length>0){let a=s[0];if(a.cards&&Array.isArray(a.cards)&&a.cards.length>0){let n=a.cards[0];if(n.weight!==void 0||n.stats!==void 0){let m="Default",f={};for(let c of s)if(c.cards&&Array.isArray(c.cards))for(let i of c.cards)i.id&&(i.weight!==void 0||i.stats!==void 0)&&(f[i.id]={weight:i.weight??1,consecutiveCorrect:i.consecutiveCorrect??0,lastDurationMs:i.lastDurationMs,stats:i.stats??{totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0}});Object.keys(f).length>0&&this.saveProgressForUser(m,f);let A=s.map(c=>({id:c.id,name:c.name,cards:c.cards.map(i=>({id:i.id,question:i.question,answer:i.answer})),createdAt:c.createdAt,updatedAt:c.updatedAt}));localStorage.setItem(e,JSON.stringify(A))}}}}localStorage.setItem(t,"true")}catch(e){console.error("Error during data migration:",e)}}getCardProgress(t){return this.userService.getCurrentUserName()&&this.getProgressForCurrentUser()[t]||null}updateCardProgress(t,e){let r=this.userService.getCurrentUserName();if(!r)return;let s=this.getProgressForCurrentUser(),a=s[t];a?s[t]=d(o(o({},a),e),{stats:o(o({},a.stats),e.stats||{})}):s[t]=d(o({weight:1,consecutiveCorrect:0},e),{stats:o({totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0},e.stats||{})}),this.saveProgressForUser(r,s),this.progressUpdateTrigger.update(n=>n+1)}getProgressForCurrentUser(){let t=this.userService.getCurrentUserName();return t?this.loadProgressForUser(t):{}}loadProgressForUser(t){if(this.progressCache.has(t))return this.progressCache.get(t);try{let e=this.getStorageKey(t),r=localStorage.getItem(e);if(!r){let a={};return this.progressCache.set(t,a),a}let s=JSON.parse(r);return this.progressCache.set(t,s),s}catch(e){console.error(`Error loading progress for user ${t}:`,e);let r={};return this.progressCache.set(t,r),r}}saveProgressForUser(t,e){try{let r=this.getStorageKey(t);localStorage.setItem(r,JSON.stringify(e)),this.progressCache.set(t,e)}catch(r){console.error(`Error saving progress for user ${t}:`,r)}}getStorageKey(t){return`${U}${t}${y}`}clearCache(){this.progressCache.clear()}initializeUserProgress(t){let e={};this.saveProgressForUser(t,e)}deleteUserProgress(t){try{let e=this.getStorageKey(t);localStorage.removeItem(e),this.progressCache.delete(t)}catch(e){console.error(`Error deleting progress for user ${t}:`,e)}}resetSetProgress(t){let e=this.userService.getCurrentUserName();if(!e)return;let r=this.getProgressForCurrentUser(),s=!1;for(let a of t)r[a]&&(delete r[a],s=!0);s&&(this.saveProgressForUser(e,r),this.progressUpdateTrigger.update(a=>a+1))}static \u0275fac=function(e){return new(e||g)};static \u0275prov=h({token:g,factory:g.\u0275fac,providedIn:"root"})};var v="school-helper-math-sets",x=class g{userProgressService=u(p);defaultWeight=1;availableSets=l([]);currentSet=l(null);currentSessionStats=l(null);constructor(){let t=this.loadFromLocalStorage(),e=this.createMockSets(),r=t.length>0?this.mergeSets(t,e):e;this.availableSets.set(r),S(()=>{let s=this.availableSets();this.saveToLocalStorage(s)})}loadFromLocalStorage(){try{let t=localStorage.getItem(v);return t?JSON.parse(t).map(r=>d(o({},r),{cards:r.cards,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt)})):[]}catch(t){return console.error("Error loading math sets from localStorage:",t),[]}}saveToLocalStorage(t){try{let e=t.map(r=>({id:r.id,name:r.name,cards:r.cards.map(s=>({id:s.id,question:s.question,answer:s.answer})),createdAt:r.createdAt.toISOString(),updatedAt:r.updatedAt.toISOString()}));localStorage.setItem(v,JSON.stringify(e))}catch(e){console.error("Error saving math sets to localStorage:",e)}}mergeSets(t,e){let r=new Set(t.map(a=>a.id)),s=e.filter(a=>!r.has(a.id));return[...t,...s]}createMockSets(){let t=new Date,e=[this.createCard("3x1","3 x 1",3),this.createCard("3x2","3 x 2",6),this.createCard("3x3","3 x 3",9),this.createCard("3x4","3 x 4",12),this.createCard("3x5","3 x 5",15),this.createCard("3x6","3 x 6",18),this.createCard("3x7","3 x 7",21),this.createCard("3x8","3 x 8",24),this.createCard("3x9","3 x 9",27),this.createCard("3x10","3 x 10",30)],r=[this.createCard("4x1","4 x 1",4),this.createCard("4x2","4 x 2",8),this.createCard("4x3","4 x 3",12),this.createCard("4x4","4 x 4",16),this.createCard("4x5","4 x 5",20),this.createCard("4x6","4 x 6",24),this.createCard("4x7","4 x 7",28),this.createCard("4x8","4 x 8",32),this.createCard("4x9","4 x 9",36),this.createCard("4x10","4 x 10",40)],s=[this.createCard("8x1","8 x 1",8),this.createCard("8x2","8 x 2",16),this.createCard("8x3","8 x 3",24),this.createCard("8x4","8 x 4",32),this.createCard("8x5","8 x 5",40),this.createCard("8x6","8 x 6",48),this.createCard("8x7","8 x 7",56),this.createCard("8x8","8 x 8",64),this.createCard("8x9","8 x 9",72),this.createCard("8x10","8 x 10",80)];return[{id:"mult-3s",name:"Multiplication 3s",cards:e,createdAt:t,updatedAt:t},{id:"mult-4s",name:"Multiplication 4s",cards:r,createdAt:t,updatedAt:t},{id:"mult-8s",name:"Multiplication 8s",cards:s,createdAt:t,updatedAt:t}]}createCard(t,e,r){return{id:t,question:e,answer:r}}mergeCardWithProgress(t){this.userProgressService.progressUpdateTrigger();let e=this.userProgressService.getCardProgress(t.id);return e?d(o({},t),{weight:e.weight,consecutiveCorrect:e.consecutiveCorrect,lastDurationMs:e.lastDurationMs,stats:e.stats}):d(o({},t),{weight:this.defaultWeight,consecutiveCorrect:0,stats:{totalAttempts:0,correctAttempts:0,fastAttempts:0,slowAttempts:0,incorrectAttempts:0}})}getCardsWithProgress(t){return t.cards.map(e=>this.mergeCardWithProgress(e))}setCurrentSet(t){let e=this.availableSets().find(r=>r.id===t);e&&this.currentSet.set(e)}clearCurrentSet(){this.currentSet.set(null)}startSession(){if(!this.currentSet())return;let e={startTime:new Date,totalQuestions:0,correctAnswers:0,fastAnswers:0,slowAnswers:0,incorrectAnswers:0,averageTimeMs:0};this.currentSessionStats.set(e)}endSession(){let t=this.currentSessionStats();t&&this.currentSessionStats.set(d(o({},t),{endTime:new Date}))}getCardById(t){let e=this.currentSet();if(!e)return;let r=e.cards.find(s=>s.id===t);if(r)return this.mergeCardWithProgress(r)}updateCard(t,e){this.userProgressService.updateCardProgress(t,{weight:e.weight,consecutiveCorrect:e.consecutiveCorrect,lastDurationMs:e.lastDurationMs,stats:e.stats})}addSet(t){let e=this.availableSets();this.availableSets.set([...e,t])}updateSet(t,e){let s=this.availableSets().map(n=>n.id===t?d(o(o({},n),e),{updatedAt:new Date}):n);this.availableSets.set(s);let a=this.currentSet();if(a&&a.id===t){let n=s.find(m=>m.id===t);n&&this.currentSet.set(n)}}getSetById(t){return this.availableSets().find(e=>e.id===t)}deleteSet(t){let r=this.availableSets().filter(a=>a.id!==t);this.availableSets.set(r);let s=this.currentSet();s&&s.id===t&&this.currentSet.set(null)}resetSetProgress(t){let e=this.getSetById(t);if(!e)return;let r=e.cards.map(s=>s.id);this.userProgressService.resetSetProgress(r)}static \u0275fac=function(e){return new(e||g)};static \u0275prov=h({token:g,factory:g.\u0275fac,providedIn:"root"})};export{p as a,x as b};

import{a as V}from"./chunk-Y2JVOSOJ.js";import{b as S}from"./chunk-QSHF6WVO.js";import{a as Q}from"./chunk-3ICQCNNT.js";import"./chunk-67XDVZMU.js";import{E as C,F as v,J as L,K as b,L as u,M as W,N as d,O as l,Q as F,R as _,S as m,T as w,Y as q,Z as o,_ as x,ca as j,da as z,g as N,ha as H,j as g,ja as R,k as A,l as D,o as k,p as K,u as B,v as h,y}from"./chunk-YKW7H7HN.js";import{a as O,b as I}from"./chunk-2NFLSA4Y.js";var E=class a{mathStateService=g(S);settingsService=g(Q);weightIncreaseOnWrong=5;weightDecreaseOnMastered=1;minWeight=1;maxWeight=7;getNextCard(e,n){if(!e||e.length===0)return null;let i=n?e.filter(c=>c.id!==n):e,t=i.length>0?i:e,r=t.reduce((c,p)=>c+p.weight,0);if(r===0)return t[Math.floor(Math.random()*t.length)];let s=Math.random()*r,f=0;for(let c of t)if(f+=c.weight,s<f)return c;return t[t.length-1]}submitAnswer(e,n,i){let t=this.mathStateService.getCardById(e);if(!t)throw new Error(`Card with id ${e} not found`);let r=this.settingsService.speedThresholdMs(),s=n===t.answer,f=s&&i<r,c=s&&i>=r,p=t.weight;s?f?p=t.weight-this.weightDecreaseOnMastered:c&&(p=t.weight+1):p=t.weight+this.weightIncreaseOnWrong,p=Math.max(this.minWeight,Math.min(this.maxWeight,p));let T={totalAttempts:t.stats.totalAttempts+1,correctAttempts:s?t.stats.correctAttempts+1:t.stats.correctAttempts,fastAttempts:f?t.stats.fastAttempts+1:t.stats.fastAttempts,slowAttempts:c?t.stats.slowAttempts+1:t.stats.slowAttempts,incorrectAttempts:s?t.stats.incorrectAttempts:t.stats.incorrectAttempts+1},P=s?t.consecutiveCorrect+1:0;return this.mathStateService.updateCard(e,{weight:p,lastDurationMs:i,consecutiveCorrect:P,stats:T}),this.updateSessionStats(s,f,c,i),{isCorrect:s,isFast:f,isSlow:c,newWeight:p}}updateSessionStats(e,n,i,t){let r=this.mathStateService.currentSessionStats();if(!r)return;let s=r.totalQuestions+1,f=e?r.correctAnswers+1:r.correctAnswers,c=n?r.fastAnswers+1:r.fastAnswers,p=i?r.slowAnswers+1:r.slowAnswers,T=e?r.incorrectAnswers:r.incorrectAnswers+1,$=(r.averageTimeMs*r.totalQuestions+t)/s;this.mathStateService.currentSessionStats.set(I(O({},r),{totalQuestions:s,correctAnswers:f,fastAnswers:c,slowAnswers:p,incorrectAnswers:T,averageTimeMs:$}))}getSpeedThresholdMs(){return this.settingsService.speedThresholdMs()}static \u0275fac=function(n){return new(n||a)};static \u0275prov=N({token:a,factory:a.\u0275fac,providedIn:"root"})};var M=class a{buttonClick=z();onButtonClick(e){this.buttonClick.emit(e)}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=y({type:a,selectors:[["app-numeric-keypad"]],outputs:{buttonClick:"buttonClick"},decls:29,vars:0,consts:[["role","group","aria-label","Numeric keypad",1,"keypad"],[1,"keypad-row"],["type","button","aria-label","One",1,"keypad-button",3,"click"],["type","button","aria-label","Two",1,"keypad-button",3,"click"],["type","button","aria-label","Three",1,"keypad-button",3,"click"],["type","button","aria-label","Four",1,"keypad-button",3,"click"],["type","button","aria-label","Five",1,"keypad-button",3,"click"],["type","button","aria-label","Six",1,"keypad-button",3,"click"],["type","button","aria-label","Seven",1,"keypad-button",3,"click"],["type","button","aria-label","Eight",1,"keypad-button",3,"click"],["type","button","aria-label","Nine",1,"keypad-button",3,"click"],["type","button","aria-label","Backspace",1,"keypad-button",3,"click"],["type","button","aria-label","Zero",1,"keypad-button",3,"click"],["type","button","aria-label","Enter",1,"keypad-button","keypad-button-enter",3,"click"]],template:function(n,i){n&1&&(d(0,"div",0)(1,"div",1)(2,"button",2),m("click",function(){return i.onButtonClick("1")}),o(3," 1 "),l(),d(4,"button",3),m("click",function(){return i.onButtonClick("2")}),o(5," 2 "),l(),d(6,"button",4),m("click",function(){return i.onButtonClick("3")}),o(7," 3 "),l()(),d(8,"div",1)(9,"button",5),m("click",function(){return i.onButtonClick("4")}),o(10," 4 "),l(),d(11,"button",6),m("click",function(){return i.onButtonClick("5")}),o(12," 5 "),l(),d(13,"button",7),m("click",function(){return i.onButtonClick("6")}),o(14," 6 "),l()(),d(15,"div",1)(16,"button",8),m("click",function(){return i.onButtonClick("7")}),o(17," 7 "),l(),d(18,"button",9),m("click",function(){return i.onButtonClick("8")}),o(19," 8 "),l(),d(20,"button",10),m("click",function(){return i.onButtonClick("9")}),o(21," 9 "),l()(),d(22,"div",1)(23,"button",11),m("click",function(){return i.onButtonClick("backspace")}),o(24," \u232B "),l(),d(25,"button",12),m("click",function(){return i.onButtonClick("0")}),o(26," 0 "),l(),d(27,"button",13),m("click",function(){return i.onButtonClick("enter")}),o(28," \u2713 "),l()()())},styles:[".keypad[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.75rem;padding:1rem;background:var(--keypad-bg, #f5f5f5);border-radius:.5rem}.keypad-row[_ngcontent-%COMP%]{display:flex;gap:.75rem;justify-content:center}.keypad-button[_ngcontent-%COMP%]{min-width:3rem;min-height:3rem;font-size:1.5rem;font-weight:600;border:2px solid var(--keypad-border, #ccc);border-radius:.5rem;background:var(--keypad-button-bg, #fff);color:var(--keypad-text, #333);cursor:pointer;transition:all .2s ease;touch-action:manipulation;-webkit-tap-highlight-color:transparent}.keypad-button[_ngcontent-%COMP%]:hover{background:var(--keypad-button-hover, #e0e0e0);transform:scale(1.05)}.keypad-button[_ngcontent-%COMP%]:active{transform:scale(.95);background:var(--keypad-button-active, #d0d0d0)}.keypad-button-enter[_ngcontent-%COMP%]{background:var(--keypad-enter-bg, #4caf50);color:var(--keypad-enter-text, #fff);border-color:var(--keypad-enter-border, #45a049)}.keypad-button-enter[_ngcontent-%COMP%]:hover{background:var(--keypad-enter-hover, #45a049)}.keypad-button-enter[_ngcontent-%COMP%]:active{background:var(--keypad-enter-active, #3d8b40)}@media(prefers-color-scheme:dark){.keypad[_ngcontent-%COMP%]{--keypad-bg: #2a2a2a;--keypad-border: #444;--keypad-button-bg: #333;--keypad-text: #fff;--keypad-button-hover: #444;--keypad-button-active: #555}}"],changeDetection:0})};function J(a,e){if(a&1&&W(0,"app-progress-indicator",5),a&2){let n=w();L("cards",n.getCardsWithProgress())}}function X(a,e){a&1&&(b(0,"div",12)(1,"span",15),o(2,"\u{1F422}"),u(),b(3,"span",16),o(4,"Too slow!"),u()())}function Y(a,e){if(a&1){let n=F();b(0,"div",7)(1,"div",8)(2,"p",9),o(3),u(),b(4,"div",10)(5,"span",11),o(6),u()(),C(7,X,5,0,"div",12),u()(),b(8,"div",13)(9,"app-numeric-keypad",14),_("buttonClick",function(t){A(n);let r=w();return D(r.onKeypadClick(t))}),u()()}if(a&2){let n=w();q("correct-feedback",n.feedback()==="correct")("incorrect-feedback",n.feedback()==="incorrect")("slow-feedback",n.feedback()==="slow"),h(3),x(n.currentCard().question),h(3),x(n.answerInput()||"?"),h(),v(n.feedback()==="slow"?7:-1)}}function ee(a,e){a&1&&(b(0,"div",6),o(1,"Loading..."),u())}var Z=class a{mathStateService=g(S);exerciseEngine=g(E);router=g(R);route=g(H);currentSet=this.mathStateService.currentSet;currentCard=k(null);answerInput=k("");feedback=k("none");questionStartTime=k(0);getCardsWithProgress=j(()=>{let e=this.currentSet();return e?this.mathStateService.getCardsWithProgress(e):[]});feedbackTimeoutId=null;currentSetId=null;isLoadingNextCard=!1;constructor(){K(()=>{let e=this.currentSet();e&&e.cards.length>0&&this.currentSetId!==e.id&&(this.currentSetId=e.id,this.loadNextCard())})}ngOnInit(){let e=this.route.snapshot.paramMap.get("setId");e?(this.mathStateService.setCurrentSet(e),this.mathStateService.startSession()):this.router.navigate(["/math"])}ngOnDestroy(){this.clearTimeouts()}handleKeyboardEvent(e){let n=this.feedback();if(!(n==="correct"||n==="slow")){if(n==="incorrect"&&(this.feedback.set("none"),this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)),e.key>="0"&&e.key<="9"){e.preventDefault(),this.onKeypadClick(e.key);return}if(e.key==="Enter"){e.preventDefault(),this.onKeypadClick("enter");return}if(e.key==="Backspace"){e.preventDefault(),this.onKeypadClick("backspace");return}}}loadNextCard(){if(this.isLoadingNextCard)return;this.isLoadingNextCard=!0;let e=this.currentSet();if(!e){this.isLoadingNextCard=!1;return}let n=this.mathStateService.getCardsWithProgress(e),i=this.currentCard()?.id,t=this.exerciseEngine.getNextCard(n,i);t&&(this.currentCard.set(t),this.answerInput.set(""),this.feedback.set("none"),this.questionStartTime.set(Date.now())),this.isLoadingNextCard=!1}onKeypadClick(e){let n=this.feedback();n==="correct"||n==="slow"||(n==="incorrect"&&(this.feedback.set("none"),this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)),e==="enter"?this.submitAnswer():e==="backspace"?this.answerInput.update(i=>i.slice(0,-1)):this.answerInput.update(i=>i+e))}submitAnswer(){let e=this.currentCard();if(!e)return;let n=parseInt(this.answerInput(),10);if(isNaN(n))return;let i=Date.now()-this.questionStartTime(),t=this.exerciseEngine.submitAnswer(e.id,n,i);t.isCorrect&&t.isFast?this.feedback.set("correct"):t.isCorrect&&t.isSlow?this.feedback.set("slow"):this.feedback.set("incorrect"),t.isCorrect?this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.loadNextCard()},500):(this.answerInput.set(""),this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.questionStartTime.set(Date.now())},1500))}endSession(){this.clearTimeouts(),this.mathStateService.endSession(),this.router.navigate(["/math/summary"])}clearTimeouts(){this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=y({type:a,selectors:[["app-exercise"]],hostBindings:function(n,i){n&1&&_("keydown",function(r){return i.handleKeyboardEvent(r)},B)},decls:10,vars:3,consts:[[1,"exercise-container"],[1,"exercise-header"],["type","button","aria-label","Exit session",1,"exit-button",3,"click"],[1,"header-content"],[1,"set-name"],[3,"cards"],[1,"loading"],[1,"question-container"],[1,"question-display"],[1,"question-text"],[1,"answer-display"],[1,"answer-value"],["aria-live","polite",1,"slow-indicator"],[1,"keypad-container"],[3,"buttonClick"],[1,"turtle-icon"],[1,"slow-text"]],template:function(n,i){if(n&1&&(b(0,"div",0)(1,"header",1)(2,"button",2),_("click",function(){return i.endSession()}),o(3," \u2715 "),u(),b(4,"div",3)(5,"h2",4),o(6),u(),C(7,J,1,1,"app-progress-indicator",5),u()(),C(8,Y,10,9)(9,ee,2,0,"div",6),u()),n&2){let t;h(6),x((t=i.currentSet())==null?null:t.name),h(),v(i.currentSet()?7:-1),h(),v(i.currentCard()?8:9)}},dependencies:[M,V],styles:[".exercise-container[_ngcontent-%COMP%]{min-height:100vh;display:flex;flex-direction:column;background:var(--bg-primary, #fff);color:var(--text-primary, #333)}.exercise-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border-color, #e0e0e0);gap:1rem}.header-content[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.75rem;min-width:0}.exit-button[_ngcontent-%COMP%]{width:44px;height:44px;border:none;background:transparent;font-size:1.5rem;color:var(--text-primary, #333);cursor:pointer;border-radius:.5rem;transition:background .2s ease}.exit-button[_ngcontent-%COMP%]:hover{background:var(--button-hover-bg, #f0f0f0)}.set-name[_ngcontent-%COMP%]{font-size:clamp(1rem,2.5vw,1.25rem);margin:0;color:var(--text-secondary, #666)}.header-content[_ngcontent-%COMP%]   app-progress-indicator[_ngcontent-%COMP%]{width:100%}.question-container[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem 1rem;transition:all .3s ease}.question-display[_ngcontent-%COMP%]{text-align:center;width:100%;max-width:600px}.question-text[_ngcontent-%COMP%]{font-size:clamp(3rem,10vw,6rem);font-weight:700;margin:0 0 2rem;color:var(--text-primary, #333);line-height:1.2}.answer-display[_ngcontent-%COMP%]{margin-bottom:1rem}.answer-value[_ngcontent-%COMP%]{font-size:clamp(2rem,6vw,4rem);font-weight:600;color:var(--answer-color, #4caf50);min-height:4rem;display:inline-block}.slow-indicator[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin-top:1rem;color:var(--slow-color, #ff9800)}.turtle-icon[_ngcontent-%COMP%]{font-size:3rem}.slow-text[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:600}.keypad-container[_ngcontent-%COMP%]{padding:1rem;background:var(--keypad-container-bg, #f5f5f5)}.loading[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--text-secondary, #666)}.correct-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_correctFlash .5s ease}.incorrect-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_incorrectShake .5s ease}.slow-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slowPulse .5s ease}@keyframes _ngcontent-%COMP%_correctFlash{0%{background:var(--bg-primary, #fff)}50%{background:var(--correct-bg, #c8e6c9)}to{background:var(--bg-primary, #fff)}}@keyframes _ngcontent-%COMP%_incorrectShake{0%,to{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-10px);background:var(--incorrect-bg, #ffcdd2)}20%,40%,60%,80%{transform:translate(10px);background:var(--incorrect-bg, #ffcdd2)}}@keyframes _ngcontent-%COMP%_slowPulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}@media(prefers-color-scheme:dark){.exercise-container[_ngcontent-%COMP%]{--bg-primary: #1a1a1a;--text-primary: #fff;--text-secondary: #aaa;--border-color: #444;--button-hover-bg: #333;--keypad-container-bg: #2a2a2a;--correct-bg: #2e7d32;--incorrect-bg: #c62828}}"],changeDetection:0})};export{Z as ExerciseComponent};

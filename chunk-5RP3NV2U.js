import{a as O}from"./chunk-J23HSJVJ.js";import{a as Z}from"./chunk-O75NO46C.js";import"./chunk-PDHAO4X2.js";import{a as E}from"./chunk-NHPTLCVL.js";import{b as Q}from"./chunk-WDXSJPWS.js";import{$ as P,E as k,F as C,K as z,L as f,M as d,N as R,O as l,P as m,R as U,S,T as u,U as w,Z as M,_ as o,aa as A,ea as T,fa as H,g as K,j as b,ja as V,k as W,l as F,la as $,o as y,p as j,u as q,v as p,y as x}from"./chunk-FYXY47SE.js";import{a as L,b as B}from"./chunk-2NFLSA4Y.js";var I=class a{mathStateService=b(O);userProgressService=b(E);weightIncreaseOnWrong=5;weightDecreaseOnMastered=1;minWeight=1;maxWeight=7;unansweredBonus=3;getNextCard(e,t){if(!e||e.length===0)return null;let i=t?e.filter(s=>s.id!==t):e,n=i.length>0?i:e,r=s=>{let v=s.weight;return s.stats.totalAttempts===0?v+this.unansweredBonus:v},c=n.reduce((s,v)=>s+r(v),0);if(c===0)return n[Math.floor(Math.random()*n.length)];let g=Math.random()*c,h=0;for(let s of n)if(h+=r(s),g<h)return s;return n[n.length-1]}submitAnswer(e,t,i){let n=this.mathStateService.getCardById(e);if(!n)throw new Error(`Card with id ${e} not found`);let r=this.mathStateService.getSpeedThresholdMs(),c=t===n.answer,g=c&&i<r,h=c&&i>=r,s=n.weight;c?g?s=n.weight-this.weightDecreaseOnMastered:h&&(s=n.weight+1):s=n.weight+this.weightIncreaseOnWrong,s=Math.max(this.minWeight,Math.min(this.maxWeight,s));let v={totalAttempts:n.stats.totalAttempts+1,correctAttempts:c?n.stats.correctAttempts+1:n.stats.correctAttempts,fastAttempts:g?n.stats.fastAttempts+1:n.stats.fastAttempts,slowAttempts:h?n.stats.slowAttempts+1:n.stats.slowAttempts,incorrectAttempts:c?n.stats.incorrectAttempts:n.stats.incorrectAttempts+1},N=c?n.consecutiveCorrect+1:0;if(this.mathStateService.updateCard(e,{weight:s,lastDurationMs:i,consecutiveCorrect:N,stats:v}),g){let _=this.mathStateService.currentLevel();_&&this.userProgressService.recordCardLevelMastery(e,_)}return this.updateSessionStats(c,g,h,i),{isCorrect:c,isFast:g,isSlow:h,newWeight:s}}updateSessionStats(e,t,i,n){let r=this.mathStateService.currentSessionStats();if(!r)return;let c=r.totalQuestions+1,g=e?r.correctAnswers+1:r.correctAnswers,h=t?r.fastAnswers+1:r.fastAnswers,s=i?r.slowAnswers+1:r.slowAnswers,v=e?r.incorrectAnswers:r.incorrectAnswers+1,_=(r.averageTimeMs*r.totalQuestions+n)/c;this.mathStateService.currentSessionStats.set(B(L({},r),{totalQuestions:c,correctAnswers:g,fastAnswers:h,slowAnswers:s,incorrectAnswers:v,averageTimeMs:_}))}getSpeedThresholdMs(){return this.mathStateService.getSpeedThresholdMs()}static \u0275fac=function(t){return new(t||a)};static \u0275prov=K({token:a,factory:a.\u0275fac,providedIn:"root"})};var D=class a{buttonClick=H();onButtonClick(e){this.buttonClick.emit(e)}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=x({type:a,selectors:[["app-numeric-keypad"]],hostAttrs:[2,"display","block","width","100%","max-width","600px"],outputs:{buttonClick:"buttonClick"},decls:29,vars:0,consts:[["role","group","aria-label","Numeric keypad",1,"keypad"],[1,"keypad-row"],["type","button","aria-label","Seven",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Eight",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Nine",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Four",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Five",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Six",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","One",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Two",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Three",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Backspace",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Zero",1,"keypad-button",3,"pointerdown"],["type","button","aria-label","Enter",1,"keypad-button","keypad-button-enter",3,"pointerdown"]],template:function(t,i){t&1&&(l(0,"div",0)(1,"div",1)(2,"button",2),u("pointerdown",function(r){return i.onButtonClick("7"),r.preventDefault()}),o(3," 7 "),m(),l(4,"button",3),u("pointerdown",function(r){return i.onButtonClick("8"),r.preventDefault()}),o(5," 8 "),m(),l(6,"button",4),u("pointerdown",function(r){return i.onButtonClick("9"),r.preventDefault()}),o(7," 9 "),m()(),l(8,"div",1)(9,"button",5),u("pointerdown",function(r){return i.onButtonClick("4"),r.preventDefault()}),o(10," 4 "),m(),l(11,"button",6),u("pointerdown",function(r){return i.onButtonClick("5"),r.preventDefault()}),o(12," 5 "),m(),l(13,"button",7),u("pointerdown",function(r){return i.onButtonClick("6"),r.preventDefault()}),o(14," 6 "),m()(),l(15,"div",1)(16,"button",8),u("pointerdown",function(r){return i.onButtonClick("1"),r.preventDefault()}),o(17," 1 "),m(),l(18,"button",9),u("pointerdown",function(r){return i.onButtonClick("2"),r.preventDefault()}),o(19," 2 "),m(),l(20,"button",10),u("pointerdown",function(r){return i.onButtonClick("3"),r.preventDefault()}),o(21," 3 "),m()(),l(22,"div",1)(23,"button",11),u("pointerdown",function(r){return i.onButtonClick("backspace"),r.preventDefault()}),o(24," \u232B "),m(),l(25,"button",12),u("pointerdown",function(r){return i.onButtonClick("0"),r.preventDefault()}),o(26," 0 "),m(),l(27,"button",13),u("pointerdown",function(r){return i.onButtonClick("enter"),r.preventDefault()}),o(28," \u2713 "),m()()())},styles:[".keypad[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:0;padding:0;background:var(--keypad-bg, #2a2a2a);max-height:100%;overflow:hidden;width:100%;max-width:600px;box-sizing:border-box;height:100%}.keypad-row[_ngcontent-%COMP%]{display:flex;gap:0;flex:1;min-height:0}.keypad-button[_ngcontent-%COMP%]{flex:1;border:none;border-right:1px solid var(--keypad-border, #444);border-bottom:1px solid var(--keypad-border, #444);background:var(--keypad-button-bg, #333);color:var(--keypad-text, #fff);cursor:pointer;transition:background .1s ease;touch-action:manipulation;-webkit-tap-highlight-color:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:clamp(1.5rem,5vh,3rem);font-weight:600;user-select:none;-webkit-user-select:none;text-align:center;min-width:0}.keypad-row[_ngcontent-%COMP%]:last-child   .keypad-button[_ngcontent-%COMP%]{border-bottom:none}.keypad-button[_ngcontent-%COMP%]:last-child{border-right:none}.keypad-button[_ngcontent-%COMP%]:hover{background:var(--keypad-button-hover, #444)}.keypad-button[_ngcontent-%COMP%]:active{background:var(--keypad-button-active, #555)}.keypad-button[_ngcontent-%COMP%]:focus{outline:2px solid var(--keypad-focus, #4caf50);outline-offset:-2px}.keypad-button-enter[_ngcontent-%COMP%]{background:var(--keypad-enter-bg, #4caf50);color:var(--keypad-enter-text, #fff)}.keypad-button-enter[_ngcontent-%COMP%]:hover{background:var(--keypad-enter-hover, #45a049)}.keypad-button-enter[_ngcontent-%COMP%]:active{background:var(--keypad-enter-active, #3d8b40)}@media(prefers-color-scheme:light){.keypad[_ngcontent-%COMP%]{--keypad-bg: #e0e0e0;--keypad-border: #ccc;--keypad-button-bg: #f5f5f5;--keypad-text: #333;--keypad-button-hover: #e0e0e0;--keypad-button-active: #d0d0d0;--keypad-focus: #4caf50}}@media(prefers-color-scheme:dark){.keypad[_ngcontent-%COMP%]{--keypad-bg: #2a2a2a;--keypad-border: #444;--keypad-button-bg: #333;--keypad-text: #fff;--keypad-button-hover: #444;--keypad-button-active: #555;--keypad-focus: #4caf50}}"],changeDetection:0})};function Y(a,e){if(a&1&&(f(0,"span",11),o(1),d()),a&2){let t=w();M("warning",t.remainingSeconds()<=10)("critical",t.remainingSeconds()<=5),p(),A(" ",t.formatTime(t.remainingSeconds())," ")}}function ee(a,e){if(a&1&&R(0,"app-progress-indicator",9),a&2){let t=w();z("cards",t.getCardsWithProgress())("setId",t.currentSet().id)("showProgressBar",!0)("currentLevelId",t.currentLevel())}}function te(a,e){a&1&&(f(0,"div",17)(1,"span",20),o(2,"\u{1F422}"),d(),f(3,"span",21),o(4,"Too slow!"),d()())}function ne(a,e){if(a&1){let t=U();f(0,"div",12)(1,"div",13)(2,"p",14),o(3),d(),f(4,"div",15)(5,"span",16),o(6),d()(),k(7,te,5,0,"div",17),d()(),f(8,"div",18)(9,"app-numeric-keypad",19),S("buttonClick",function(n){W(t);let r=w();return F(r.onKeypadClick(n))}),d()()}if(a&2){let t=w();M("correct-feedback",t.feedback()==="correct")("incorrect-feedback",t.feedback()==="incorrect")("slow-feedback",t.feedback()==="slow"),p(3),P(t.currentCard().question),p(3),P(t.answerInput()||"?"),p(),C(t.feedback()==="slow"?7:-1)}}function re(a,e){a&1&&(f(0,"div",10),o(1,"Loading..."),d())}var J=class a{mathStateService=b(O);exerciseEngine=b(I);userProgressService=b(E);router=b($);route=b(V);currentSet=this.mathStateService.currentSet;currentCard=y(null);answerInput=y("");feedback=y("none");questionStartTime=y(0);remainingSeconds=y(0);timerIntervalId=null;currentMode=this.mathStateService.currentMode;currentLevel=this.mathStateService.currentLevel;currentTimedDuration=this.mathStateService.currentTimedDuration;isTimedMode=T(()=>this.currentMode()==="timed");levelName=T(()=>Q(this.currentLevel()).name);getCardsWithProgress=T(()=>{let e=this.currentSet();return e?this.mathStateService.getCardsWithProgress(e):[]});feedbackTimeoutId=null;currentSetId=null;isLoadingNextCard=!1;constructor(){j(()=>{let e=this.currentSet();e&&e.cards.length>0&&this.currentSetId!==e.id&&(this.currentSetId=e.id,this.loadNextCard())})}ngOnInit(){let e=this.route.snapshot.paramMap.get("setId");if(e){if(this.mathStateService.setCurrentSet(e),this.mathStateService.startSession(),this.isTimedMode()){let t=this.currentTimedDuration();t&&(this.remainingSeconds.set(t),this.startTimer())}}else this.router.navigate(["/math/multiplication-facts"])}ngOnDestroy(){this.clearTimeouts(),this.stopTimer()}startTimer(){this.timerIntervalId=window.setInterval(()=>{this.remainingSeconds()<=1?(this.remainingSeconds.set(0),this.stopTimer(),this.endSession()):this.remainingSeconds.update(t=>t-1)},1e3)}stopTimer(){this.timerIntervalId!==null&&(clearInterval(this.timerIntervalId),this.timerIntervalId=null)}formatTime(e){let t=Math.floor(e/60),i=e%60;return t>0?`${t}:${i.toString().padStart(2,"0")}`:`${i}s`}handleKeyboardEvent(e){let t=this.feedback();if(!(t==="correct"||t==="slow")){if(t==="incorrect"&&(this.feedback.set("none"),this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)),e.key>="0"&&e.key<="9"){e.preventDefault(),this.onKeypadClick(e.key);return}if(e.key==="Enter"){e.preventDefault(),this.onKeypadClick("enter");return}if(e.key==="Backspace"){e.preventDefault(),this.onKeypadClick("backspace");return}}}loadNextCard(){if(this.isLoadingNextCard)return;this.isLoadingNextCard=!0;let e=this.currentSet();if(!e){this.isLoadingNextCard=!1;return}let t=this.mathStateService.getCardsWithProgress(e),i=this.currentCard()?.id,n=this.exerciseEngine.getNextCard(t,i);n&&(this.currentCard.set(n),this.answerInput.set(""),this.feedback.set("none"),this.questionStartTime.set(Date.now())),this.isLoadingNextCard=!1}onKeypadClick(e){let t=this.feedback();t==="correct"||t==="slow"||(t==="incorrect"&&(this.feedback.set("none"),this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)),e==="enter"?this.submitAnswer():e==="backspace"?this.answerInput.update(i=>i.slice(0,-1)):this.answerInput.update(i=>i+e))}submitAnswer(){let e=this.currentCard();if(!e)return;let t=parseInt(this.answerInput(),10);if(isNaN(t))return;let i=Date.now()-this.questionStartTime(),n=this.exerciseEngine.submitAnswer(e.id,t,i);n.isCorrect&&n.isFast?this.feedback.set("correct"):n.isCorrect&&n.isSlow?this.feedback.set("slow"):this.feedback.set("incorrect"),n.isCorrect?this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),n.isFast&&this.currentMode()==="master"&&this.isSetMasteredAtCurrentLevel()?this.endSession():this.loadNextCard()},500):(this.answerInput.set(""),this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.questionStartTime.set(Date.now())},1500))}endSession(){this.clearTimeouts(),this.stopTimer(),this.currentMode()==="master"&&this.checkAndRecordMastery(),this.mathStateService.endSession(),this.router.navigate(["/math/multiplication-facts/summary"])}isSetMasteredAtCurrentLevel(){let e=this.currentSet(),t=this.currentLevel();return!e||!t?!1:this.mathStateService.getCardsWithProgress(e).every(n=>this.userProgressService.isCardMasteredAtLevel(n.id,t))}checkAndRecordMastery(){let e=this.currentSet(),t=this.currentLevel();!e||!t||this.isSetMasteredAtCurrentLevel()&&this.userProgressService.recordSetMastery(e.id,t)}clearTimeouts(){this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)}static \u0275fac=function(t){return new(t||a)};static \u0275cmp=x({type:a,selectors:[["app-exercise"]],hostBindings:function(t,i){t&1&&S("keydown",function(r){return i.handleKeyboardEvent(r)},q)},decls:15,vars:7,consts:[[1,"exercise-container"],[1,"exercise-header"],["type","button","aria-label","Exit session",1,"exit-button",3,"click"],[1,"header-content"],[1,"header-row"],[1,"set-name"],[1,"header-badges"],[1,"level-badge"],["aria-live","polite",1,"timer-badge",3,"warning","critical"],[3,"cards","setId","showProgressBar","currentLevelId"],[1,"loading"],["aria-live","polite",1,"timer-badge"],[1,"question-container"],[1,"question-display"],[1,"question-text"],[1,"answer-display"],[1,"answer-value"],["aria-live","polite",1,"slow-indicator"],[1,"keypad-container"],[3,"buttonClick"],[1,"turtle-icon"],[1,"slow-text"]],template:function(t,i){if(t&1&&(f(0,"div",0)(1,"header",1)(2,"button",2),S("click",function(){return i.endSession()}),o(3," \u2715 "),d(),f(4,"div",3)(5,"div",4)(6,"h2",5),o(7),d(),f(8,"div",6)(9,"span",7),o(10),d(),k(11,Y,2,5,"span",8),d()(),k(12,ee,1,4,"app-progress-indicator",9),d()(),k(13,ne,10,9)(14,re,2,0,"div",10),d()),t&2){let n;p(7),P((n=i.currentSet())==null?null:n.name),p(2),M("ninja",i.currentLevel()==="ninja"),p(),A(" ",i.levelName()," "),p(),C(i.isTimedMode()?11:-1),p(),C(i.currentSet()&&!i.isTimedMode()?12:-1),p(),C(i.currentCard()?13:14)}},dependencies:[D,Z],styles:[".exercise-container[_ngcontent-%COMP%]{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;background:var(--bg-primary, #fff);color:var(--text-primary, #333)}.exercise-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border-color, #e0e0e0);gap:1rem}.header-content[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.75rem;min-width:0}.exit-button[_ngcontent-%COMP%]{width:44px;height:44px;border:none;background:transparent;font-size:1.5rem;color:var(--text-primary, #333);cursor:pointer;border-radius:.5rem;transition:background .2s ease}.exit-button[_ngcontent-%COMP%]:hover{background:var(--button-hover-bg, #f0f0f0)}.set-name[_ngcontent-%COMP%]{font-size:clamp(1rem,2.5vw,1.25rem);margin:0;color:var(--text-secondary, #666)}.header-row[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:.5rem}.header-badges[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center}.level-badge[_ngcontent-%COMP%]{font-size:.75rem;font-weight:600;padding:.25rem .5rem;border-radius:.25rem;background:var(--level-bg, #e0e0e0);color:var(--level-text, #333)}.level-badge.ninja[_ngcontent-%COMP%]{background:linear-gradient(135deg,#1a1a1a,#333);color:#fff}.timer-badge[_ngcontent-%COMP%]{font-size:1rem;font-weight:700;padding:.25rem .75rem;border-radius:.25rem;background:var(--timer-bg, #2196f3);color:var(--timer-text, #fff);min-width:60px;text-align:center;font-variant-numeric:tabular-nums}.timer-badge.warning[_ngcontent-%COMP%]{background:var(--timer-warning, #ff9800);animation:_ngcontent-%COMP%_timerPulse 1s infinite}.timer-badge.critical[_ngcontent-%COMP%]{background:var(--timer-critical, #f44336);animation:_ngcontent-%COMP%_timerPulse .5s infinite}@keyframes _ngcontent-%COMP%_timerPulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}.header-content[_ngcontent-%COMP%]   app-progress-indicator[_ngcontent-%COMP%]{width:100%}.question-container[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem 1rem;transition:all .3s ease;max-height:40vh;min-height:0;overflow:hidden}.question-display[_ngcontent-%COMP%]{text-align:center;width:100%;max-width:600px;display:flex;flex-direction:column;justify-content:center;align-items:center;max-height:100%;overflow:hidden}.question-text[_ngcontent-%COMP%]{font-size:clamp(2rem,min(8vw,6vh),5rem);font-weight:700;margin:0 0 clamp(1rem,2vh,2rem) 0;color:var(--text-primary, #333);line-height:1.2;flex-shrink:1}.answer-display[_ngcontent-%COMP%]{margin-bottom:clamp(.5rem,1vh,1rem);flex-shrink:1}.answer-value[_ngcontent-%COMP%]{font-size:clamp(1.5rem,min(5vw,4vh),3.5rem);font-weight:600;color:var(--answer-color, #4caf50);min-height:clamp(2rem,4vh,4rem);display:inline-block}.slow-indicator[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin-top:1rem;color:var(--slow-color, #ff9800)}.turtle-icon[_ngcontent-%COMP%]{font-size:3rem}.slow-text[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:600}.keypad-container[_ngcontent-%COMP%]{padding:0;background:var(--keypad-container-bg, #2a2a2a);flex-shrink:0;overflow:hidden;flex:1;min-height:0;display:flex;align-items:stretch;justify-content:center;width:100%;max-width:600px;margin:0 auto}.loading[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--text-secondary, #666)}.correct-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_correctFlash .5s ease}.incorrect-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_incorrectShake .5s ease}.slow-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slowPulse .5s ease}@keyframes _ngcontent-%COMP%_correctFlash{0%{background:var(--bg-primary, #fff)}50%{background:var(--correct-bg, #e8f5e9)}to{background:var(--bg-primary, #fff)}}@keyframes _ngcontent-%COMP%_incorrectShake{0%,to{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-10px);background:var(--incorrect-bg, #ffcdd2)}20%,40%,60%,80%{transform:translate(10px);background:var(--incorrect-bg, #ffcdd2)}}@keyframes _ngcontent-%COMP%_slowPulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}@media(prefers-color-scheme:dark){.exercise-container[_ngcontent-%COMP%]{--bg-primary: #1a1a1a;--text-primary: #fff;--text-secondary: #aaa;--border-color: #444;--button-hover-bg: #333;--keypad-container-bg: #2a2a2a;--correct-bg: #2e7d32;--incorrect-bg: #c62828;--level-bg: #444;--level-text: #fff;--timer-bg: #2196f3;--timer-text: #fff;--timer-warning: #ff9800;--timer-critical: #f44336}}"],changeDetection:0})};export{J as ExerciseComponent};

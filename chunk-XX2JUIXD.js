import{a as V}from"./chunk-KOCFH3FQ.js";import{b as S}from"./chunk-MNR4JMD7.js";import{a as Q}from"./chunk-X2MT6UCR.js";import"./chunk-4USDWUO2.js";import{E as C,F as v,J as L,K as h,L as u,M as W,N as d,O as l,Q as F,R as _,S as m,T as x,Y as q,Z as r,_ as w,ca as j,da as z,g as N,ha as H,j as b,ja as R,k as A,l as D,o as k,p as K,u as B,v as g,y}from"./chunk-BRS2FBVW.js";import{a as O,b as I}from"./chunk-2NFLSA4Y.js";var E=class a{mathStateService=b(S);settingsService=b(Q);weightIncreaseOnWrong=5;weightDecreaseOnMastered=1;minWeight=1;maxWeight=7;getNextCard(e,n){if(!e||e.length===0)return null;let i=n?e.filter(c=>c.id!==n):e,t=i.length>0?i:e,o=t.reduce((c,p)=>c+p.weight,0);if(o===0)return t[Math.floor(Math.random()*t.length)];let s=Math.random()*o,f=0;for(let c of t)if(f+=c.weight,s<f)return c;return t[t.length-1]}submitAnswer(e,n,i){let t=this.mathStateService.getCardById(e);if(!t)throw new Error(`Card with id ${e} not found`);let o=this.settingsService.speedThresholdMs(),s=n===t.answer,f=s&&i<o,c=s&&i>=o,p=t.weight;s?f?p=t.weight-this.weightDecreaseOnMastered:c&&(p=t.weight+1):p=t.weight+this.weightIncreaseOnWrong,p=Math.max(this.minWeight,Math.min(this.maxWeight,p));let T={totalAttempts:t.stats.totalAttempts+1,correctAttempts:s?t.stats.correctAttempts+1:t.stats.correctAttempts,fastAttempts:f?t.stats.fastAttempts+1:t.stats.fastAttempts,slowAttempts:c?t.stats.slowAttempts+1:t.stats.slowAttempts,incorrectAttempts:s?t.stats.incorrectAttempts:t.stats.incorrectAttempts+1},P=s?t.consecutiveCorrect+1:0;return this.mathStateService.updateCard(e,{weight:p,lastDurationMs:i,consecutiveCorrect:P,stats:T}),this.updateSessionStats(s,f,c,i),{isCorrect:s,isFast:f,isSlow:c,newWeight:p}}updateSessionStats(e,n,i,t){let o=this.mathStateService.currentSessionStats();if(!o)return;let s=o.totalQuestions+1,f=e?o.correctAnswers+1:o.correctAnswers,c=n?o.fastAnswers+1:o.fastAnswers,p=i?o.slowAnswers+1:o.slowAnswers,T=e?o.incorrectAnswers:o.incorrectAnswers+1,$=(o.averageTimeMs*o.totalQuestions+t)/s;this.mathStateService.currentSessionStats.set(I(O({},o),{totalQuestions:s,correctAnswers:f,fastAnswers:c,slowAnswers:p,incorrectAnswers:T,averageTimeMs:$}))}getSpeedThresholdMs(){return this.settingsService.speedThresholdMs()}static \u0275fac=function(n){return new(n||a)};static \u0275prov=N({token:a,factory:a.\u0275fac,providedIn:"root"})};var M=class a{buttonClick=z();onButtonClick(e){this.buttonClick.emit(e)}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=y({type:a,selectors:[["app-numeric-keypad"]],hostAttrs:[2,"display","block","width","100%","max-width","600px"],outputs:{buttonClick:"buttonClick"},decls:29,vars:0,consts:[["role","group","aria-label","Numeric keypad",1,"keypad"],[1,"keypad-row"],["type","button","aria-label","Seven",1,"keypad-button",3,"click"],["type","button","aria-label","Eight",1,"keypad-button",3,"click"],["type","button","aria-label","Nine",1,"keypad-button",3,"click"],["type","button","aria-label","Four",1,"keypad-button",3,"click"],["type","button","aria-label","Five",1,"keypad-button",3,"click"],["type","button","aria-label","Six",1,"keypad-button",3,"click"],["type","button","aria-label","One",1,"keypad-button",3,"click"],["type","button","aria-label","Two",1,"keypad-button",3,"click"],["type","button","aria-label","Three",1,"keypad-button",3,"click"],["type","button","aria-label","Backspace",1,"keypad-button",3,"click"],["type","button","aria-label","Zero",1,"keypad-button",3,"click"],["type","button","aria-label","Enter",1,"keypad-button","keypad-button-enter",3,"click"]],template:function(n,i){n&1&&(d(0,"div",0)(1,"div",1)(2,"button",2),m("click",function(){return i.onButtonClick("7")}),r(3," 7 "),l(),d(4,"button",3),m("click",function(){return i.onButtonClick("8")}),r(5," 8 "),l(),d(6,"button",4),m("click",function(){return i.onButtonClick("9")}),r(7," 9 "),l()(),d(8,"div",1)(9,"button",5),m("click",function(){return i.onButtonClick("4")}),r(10," 4 "),l(),d(11,"button",6),m("click",function(){return i.onButtonClick("5")}),r(12," 5 "),l(),d(13,"button",7),m("click",function(){return i.onButtonClick("6")}),r(14," 6 "),l()(),d(15,"div",1)(16,"button",8),m("click",function(){return i.onButtonClick("1")}),r(17," 1 "),l(),d(18,"button",9),m("click",function(){return i.onButtonClick("2")}),r(19," 2 "),l(),d(20,"button",10),m("click",function(){return i.onButtonClick("3")}),r(21," 3 "),l()(),d(22,"div",1)(23,"button",11),m("click",function(){return i.onButtonClick("backspace")}),r(24," \u232B "),l(),d(25,"button",12),m("click",function(){return i.onButtonClick("0")}),r(26," 0 "),l(),d(27,"button",13),m("click",function(){return i.onButtonClick("enter")}),r(28," \u2713 "),l()()())},styles:[".keypad[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:0;padding:0;background:var(--keypad-bg, #2a2a2a);max-height:100%;overflow:hidden;width:100%;max-width:600px;box-sizing:border-box;height:100%}.keypad-row[_ngcontent-%COMP%]{display:flex;gap:0;flex:1;min-height:0}.keypad-button[_ngcontent-%COMP%]{flex:1;border:none;border-right:1px solid var(--keypad-border, #444);border-bottom:1px solid var(--keypad-border, #444);background:var(--keypad-button-bg, #333);color:var(--keypad-text, #fff);cursor:pointer;transition:background .1s ease;touch-action:manipulation;-webkit-tap-highlight-color:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:clamp(1.5rem,5vh,3rem);font-weight:600;user-select:none;-webkit-user-select:none;text-align:center;min-width:0}.keypad-row[_ngcontent-%COMP%]:last-child   .keypad-button[_ngcontent-%COMP%]{border-bottom:none}.keypad-button[_ngcontent-%COMP%]:last-child{border-right:none}.keypad-button[_ngcontent-%COMP%]:hover{background:var(--keypad-button-hover, #444)}.keypad-button[_ngcontent-%COMP%]:active{background:var(--keypad-button-active, #555)}.keypad-button[_ngcontent-%COMP%]:focus{outline:2px solid var(--keypad-focus, #4caf50);outline-offset:-2px}.keypad-button-enter[_ngcontent-%COMP%]{background:var(--keypad-enter-bg, #4caf50);color:var(--keypad-enter-text, #fff)}.keypad-button-enter[_ngcontent-%COMP%]:hover{background:var(--keypad-enter-hover, #45a049)}.keypad-button-enter[_ngcontent-%COMP%]:active{background:var(--keypad-enter-active, #3d8b40)}@media(prefers-color-scheme:light){.keypad[_ngcontent-%COMP%]{--keypad-bg: #e0e0e0;--keypad-border: #ccc;--keypad-button-bg: #f5f5f5;--keypad-text: #333;--keypad-button-hover: #e0e0e0;--keypad-button-active: #d0d0d0;--keypad-focus: #4caf50}}@media(prefers-color-scheme:dark){.keypad[_ngcontent-%COMP%]{--keypad-bg: #2a2a2a;--keypad-border: #444;--keypad-button-bg: #333;--keypad-text: #fff;--keypad-button-hover: #444;--keypad-button-active: #555;--keypad-focus: #4caf50}}"],changeDetection:0})};function J(a,e){if(a&1&&W(0,"app-progress-indicator",5),a&2){let n=x();L("cards",n.getCardsWithProgress())}}function X(a,e){a&1&&(h(0,"div",12)(1,"span",15),r(2,"\u{1F422}"),u(),h(3,"span",16),r(4,"Too slow!"),u()())}function Y(a,e){if(a&1){let n=F();h(0,"div",7)(1,"div",8)(2,"p",9),r(3),u(),h(4,"div",10)(5,"span",11),r(6),u()(),C(7,X,5,0,"div",12),u()(),h(8,"div",13)(9,"app-numeric-keypad",14),_("buttonClick",function(t){A(n);let o=x();return D(o.onKeypadClick(t))}),u()()}if(a&2){let n=x();q("correct-feedback",n.feedback()==="correct")("incorrect-feedback",n.feedback()==="incorrect")("slow-feedback",n.feedback()==="slow"),g(3),w(n.currentCard().question),g(3),w(n.answerInput()||"?"),g(),v(n.feedback()==="slow"?7:-1)}}function ee(a,e){a&1&&(h(0,"div",6),r(1,"Loading..."),u())}var Z=class a{mathStateService=b(S);exerciseEngine=b(E);router=b(R);route=b(H);currentSet=this.mathStateService.currentSet;currentCard=k(null);answerInput=k("");feedback=k("none");questionStartTime=k(0);getCardsWithProgress=j(()=>{let e=this.currentSet();return e?this.mathStateService.getCardsWithProgress(e):[]});feedbackTimeoutId=null;currentSetId=null;isLoadingNextCard=!1;constructor(){K(()=>{let e=this.currentSet();e&&e.cards.length>0&&this.currentSetId!==e.id&&(this.currentSetId=e.id,this.loadNextCard())})}ngOnInit(){let e=this.route.snapshot.paramMap.get("setId");e?(this.mathStateService.setCurrentSet(e),this.mathStateService.startSession()):this.router.navigate(["/math"])}ngOnDestroy(){this.clearTimeouts()}handleKeyboardEvent(e){let n=this.feedback();if(!(n==="correct"||n==="slow")){if(n==="incorrect"&&(this.feedback.set("none"),this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)),e.key>="0"&&e.key<="9"){e.preventDefault(),this.onKeypadClick(e.key);return}if(e.key==="Enter"){e.preventDefault(),this.onKeypadClick("enter");return}if(e.key==="Backspace"){e.preventDefault(),this.onKeypadClick("backspace");return}}}loadNextCard(){if(this.isLoadingNextCard)return;this.isLoadingNextCard=!0;let e=this.currentSet();if(!e){this.isLoadingNextCard=!1;return}let n=this.mathStateService.getCardsWithProgress(e),i=this.currentCard()?.id,t=this.exerciseEngine.getNextCard(n,i);t&&(this.currentCard.set(t),this.answerInput.set(""),this.feedback.set("none"),this.questionStartTime.set(Date.now())),this.isLoadingNextCard=!1}onKeypadClick(e){let n=this.feedback();n==="correct"||n==="slow"||(n==="incorrect"&&(this.feedback.set("none"),this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)),e==="enter"?this.submitAnswer():e==="backspace"?this.answerInput.update(i=>i.slice(0,-1)):this.answerInput.update(i=>i+e))}submitAnswer(){let e=this.currentCard();if(!e)return;let n=parseInt(this.answerInput(),10);if(isNaN(n))return;let i=Date.now()-this.questionStartTime(),t=this.exerciseEngine.submitAnswer(e.id,n,i);t.isCorrect&&t.isFast?this.feedback.set("correct"):t.isCorrect&&t.isSlow?this.feedback.set("slow"):this.feedback.set("incorrect"),t.isCorrect?this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.loadNextCard()},500):(this.answerInput.set(""),this.feedbackTimeoutId=window.setTimeout(()=>{this.feedback.set("none"),this.questionStartTime.set(Date.now())},1500))}endSession(){this.clearTimeouts(),this.mathStateService.endSession(),this.router.navigate(["/math/summary"])}clearTimeouts(){this.feedbackTimeoutId!==null&&(clearTimeout(this.feedbackTimeoutId),this.feedbackTimeoutId=null)}static \u0275fac=function(n){return new(n||a)};static \u0275cmp=y({type:a,selectors:[["app-exercise"]],hostBindings:function(n,i){n&1&&_("keydown",function(o){return i.handleKeyboardEvent(o)},B)},decls:10,vars:3,consts:[[1,"exercise-container"],[1,"exercise-header"],["type","button","aria-label","Exit session",1,"exit-button",3,"click"],[1,"header-content"],[1,"set-name"],[3,"cards"],[1,"loading"],[1,"question-container"],[1,"question-display"],[1,"question-text"],[1,"answer-display"],[1,"answer-value"],["aria-live","polite",1,"slow-indicator"],[1,"keypad-container"],[3,"buttonClick"],[1,"turtle-icon"],[1,"slow-text"]],template:function(n,i){if(n&1&&(h(0,"div",0)(1,"header",1)(2,"button",2),_("click",function(){return i.endSession()}),r(3," \u2715 "),u(),h(4,"div",3)(5,"h2",4),r(6),u(),C(7,J,1,1,"app-progress-indicator",5),u()(),C(8,Y,10,9)(9,ee,2,0,"div",6),u()),n&2){let t;g(6),w((t=i.currentSet())==null?null:t.name),g(),v(i.currentSet()?7:-1),g(),v(i.currentCard()?8:9)}},dependencies:[M,V],styles:[".exercise-container[_ngcontent-%COMP%]{min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;background:var(--bg-primary, #fff);color:var(--text-primary, #333)}.exercise-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border-color, #e0e0e0);gap:1rem}.header-content[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:.75rem;min-width:0}.exit-button[_ngcontent-%COMP%]{width:44px;height:44px;border:none;background:transparent;font-size:1.5rem;color:var(--text-primary, #333);cursor:pointer;border-radius:.5rem;transition:background .2s ease}.exit-button[_ngcontent-%COMP%]:hover{background:var(--button-hover-bg, #f0f0f0)}.set-name[_ngcontent-%COMP%]{font-size:clamp(1rem,2.5vw,1.25rem);margin:0;color:var(--text-secondary, #666)}.header-content[_ngcontent-%COMP%]   app-progress-indicator[_ngcontent-%COMP%]{width:100%}.question-container[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;padding:2rem 1rem;transition:all .3s ease;max-height:40vh;min-height:0;overflow:hidden}.question-display[_ngcontent-%COMP%]{text-align:center;width:100%;max-width:600px;display:flex;flex-direction:column;justify-content:center;align-items:center;max-height:100%;overflow:hidden}.question-text[_ngcontent-%COMP%]{font-size:clamp(2rem,min(8vw,6vh),5rem);font-weight:700;margin:0 0 clamp(1rem,2vh,2rem) 0;color:var(--text-primary, #333);line-height:1.2;flex-shrink:1}.answer-display[_ngcontent-%COMP%]{margin-bottom:clamp(.5rem,1vh,1rem);flex-shrink:1}.answer-value[_ngcontent-%COMP%]{font-size:clamp(1.5rem,min(5vw,4vh),3.5rem);font-weight:600;color:var(--answer-color, #4caf50);min-height:clamp(2rem,4vh,4rem);display:inline-block}.slow-indicator[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:.5rem;margin-top:1rem;color:var(--slow-color, #ff9800)}.turtle-icon[_ngcontent-%COMP%]{font-size:3rem}.slow-text[_ngcontent-%COMP%]{font-size:1.25rem;font-weight:600}.keypad-container[_ngcontent-%COMP%]{padding:0;background:var(--keypad-container-bg, #2a2a2a);flex-shrink:0;overflow:hidden;flex:1;min-height:0;display:flex;align-items:stretch;justify-content:center;width:100%;max-width:600px;margin:0 auto}.loading[_ngcontent-%COMP%]{flex:1;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--text-secondary, #666)}.correct-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_correctFlash .5s ease}.incorrect-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_incorrectShake .5s ease}.slow-feedback[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_slowPulse .5s ease}@keyframes _ngcontent-%COMP%_correctFlash{0%{background:var(--bg-primary, #fff)}50%{background:var(--correct-bg, #c8e6c9)}to{background:var(--bg-primary, #fff)}}@keyframes _ngcontent-%COMP%_incorrectShake{0%,to{transform:translate(0)}10%,30%,50%,70%,90%{transform:translate(-10px);background:var(--incorrect-bg, #ffcdd2)}20%,40%,60%,80%{transform:translate(10px);background:var(--incorrect-bg, #ffcdd2)}}@keyframes _ngcontent-%COMP%_slowPulse{0%,to{transform:scale(1)}50%{transform:scale(1.05)}}@media(prefers-color-scheme:dark){.exercise-container[_ngcontent-%COMP%]{--bg-primary: #1a1a1a;--text-primary: #fff;--text-secondary: #aaa;--border-color: #444;--button-hover-bg: #333;--keypad-container-bg: #2a2a2a;--correct-bg: #2e7d32;--incorrect-bg: #c62828}}"],changeDetection:0})};export{Z as ExerciseComponent};
